import os.path
from pathlib import Path

import matplotlib.pyplot as plt
import numpy as np
import pandas as pd
save=False




xlabel_dict = {'curvature_bird_air_abs':     '$|\\kappa_\\mathrm{bird,air}|$',
                'curvature_bird_ground_abs': '$|\\kappa_\\mathrm{bird,ground}|$',
                'dKdT_bird_air_abs':         '$|d\\kappa/d t _\\mathrm{bird,air}|$',
                'dKdT_bird_ground_abs':      '$|d\\kappa/d t _\\mathrm{bird,ground}|$', }



compared_against = 'DEC'
df_concat                       = pd.read_csv('results/behaviour/EER/histograms/eer_sweep/DEC/samples.csv', index_col=False)
df_all_histograms               = pd.read_csv('results/behaviour/EER/histograms/eer_sweep/DEC/hist_per_bird.csv', index_col=False)

df_ks                           = pd.read_csv(f'results/behaviour/EER/histograms/eer_sweep/DEC/metrics_{compared_against}.csv', index_col=False)
df_all_histograms_resampled_gt  = pd.read_csv(f'results/behaviour/EER/histograms/eer_sweep/{compared_against}/hist_resampled.csv', index_col=False)

df_all_histograms.rename(columns={'path_to_synthetic': 'bird_name'}, inplace=True)

list_of_birds = df_ks['bird_name'].sort_values().unique()
list_of_EER = sorted(df_all_histograms_resampled_gt['EER_index'].unique())
my_bins = np.sort(np.unique(df_all_histograms_resampled_gt[['bin_min', 'bin_max']].values))
########################################################################################################################
###############################################             BEST SCALE        ##########################################
########################################################################################################################
list_of_metrics = ['ks', 'chi2', 'relative_entropy_bird_eer',
                          'relative_entropy_eer_bird']
list_of_scales = np.sort(df_ks['scale'].unique())
list_of_columns = np.sort(df_ks['col'].unique())
df_best_scale = df_ks[ ['col', 'scale']  + list_of_metrics].groupby(['col', 'scale']).agg(**{f'{col}_{stat}': (col, stat)
                                                                                             for col in list_of_metrics
                                                                                             for stat in ['mean', 'median', 'std', 'sem', 'count']}).reset_index()
fig_violin, ax_violin = plt.subplots(2,1, sharey='row', sharex='all')

for i_col, col in enumerate(list_of_columns):
    current_df_col = df_ks[df_ks['col'] == col]
    ax_violin[i_col].violinplot([current_df_col.loc[round(current_df_col['scale'],1) == round(scale,1), 'chi2'].values for i_scale, scale in enumerate(list_of_scales)],
                                list_of_scales, widths=0.05, showmeans=True
                            )


df_ks = df_ks[df_ks['scale'] == 1]

common_cols = ['bird_name', 'col', 'actual_EER_index', 'EER',]

df_ks_min = pd.merge(df_ks,
                     df_ks[common_cols + ['ks']].groupby(common_cols).agg(
                         best_index=('ks', 'idxmin')).reset_index().drop(columns=common_cols),
         left_index=True, right_on='best_index')


df_chi2_min = pd.merge(df_ks,
                     df_ks[common_cols + ['chi2']].groupby(common_cols).agg(
                         best_index=('chi2', 'idxmin')).reset_index().drop(columns=common_cols),
         left_index=True, right_on='best_index')
df_rel_entropy_bird_eer_min = pd.merge(df_ks,
                     df_ks[common_cols + ['relative_entropy_bird_eer']].groupby(common_cols).agg(
                         best_index=('relative_entropy_bird_eer', 'idxmin')).reset_index().drop(columns=common_cols),
         left_index=True, right_on='best_index')
df_rel_entropy_eer_bird_min = pd.merge(df_ks,
                     df_ks[common_cols + ['relative_entropy_eer_bird']].groupby(common_cols).agg(
                         best_index=('relative_entropy_eer_bird', 'idxmin')).reset_index().drop(columns=common_cols),
         left_index=True, right_on='best_index')

df_ks_min.rename(columns={'EER_index': 'EER_index_ks'}, inplace=True)
df_chi2_min.rename(columns={'EER_index': 'EER_index_chi2'}, inplace=True)
df_rel_entropy_bird_eer_min.rename(columns={'EER_index': 'EER_index_rel_entropy_bird_eer'}, inplace=True)
df_rel_entropy_eer_bird_min.rename(columns={'EER_index': 'EER_index_rel_entropy_eer_bird'}, inplace=True)
df_ks_min.rename(columns={'scale': 'scale_ks'}, inplace=True)
df_chi2_min.rename(columns={'scale': 'scale_chi2'}, inplace=True)
df_rel_entropy_bird_eer_min.rename(columns={'scale': 'scale_rel_entropy_bird_eer'}, inplace=True)
df_rel_entropy_eer_bird_min.rename(columns={'scale': 'scale_rel_entropy_eer_bird'}, inplace=True)

df_all_mins = pd.merge(df_ks_min[common_cols + ['EER_index_ks', 'scale_ks', 'ks', 'ks_pvalue', 'ks_location', 'ks_sign']],
                       df_chi2_min[common_cols + ['EER_index_chi2', 'scale_chi2','chi2']], on=common_cols)

df_all_mins = pd.merge(df_all_mins,
                       df_rel_entropy_bird_eer_min[common_cols + ['EER_index_rel_entropy_bird_eer', 'scale_rel_entropy_bird_eer', 'relative_entropy_bird_eer']], on=common_cols)
df_all_mins = pd.merge(df_all_mins,
                       df_rel_entropy_eer_bird_min[common_cols + ['EER_index_rel_entropy_eer_bird', 'scale_rel_entropy_eer_bird', 'relative_entropy_eer_bird']], on=common_cols)



dddd = df_all_mins[['actual_EER_index','EER_index_ks', 'EER_index_chi2', 'EER_index_rel_entropy_bird_eer', 'EER_index_rel_entropy_eer_bird',]].corr()

df_all_mins_stats = df_all_mins[['actual_EER_index',
                                 'EER_index_ks',
                                 'EER_index_chi2',
                                 'EER_index_rel_entropy_bird_eer',
                                 'EER_index_rel_entropy_eer_bird']].groupby('actual_EER_index'
                                                                            ).agg(**{f'{col}_{stat}': (col, stat)
                                                                                     for col in ['EER_index_ks',
                                                                                                 'EER_index_chi2',
                                                                                                 'EER_index_rel_entropy_bird_eer',
                                                                                                 'EER_index_rel_entropy_eer_bird']
                                                                                     for stat in ['mean', 'median', 'std', 'sem', 'count']})

list_of_actual_EER_index = np.sort(df_all_mins['actual_EER_index'].unique())
fig, ax = plt.subplots(1,2, sharex='all')

for i_m, m in enumerate(list_of_metrics[:2]):
    ax[i_m].violinplot([df_all_mins.loc[round(df_all_mins['actual_EER_index'], 1) == round(eer, 1), f'EER_index_{m.replace("relative", "rel")}'].values for i_eer, eer in
                        enumerate(list_of_actual_EER_index)],
                       list_of_actual_EER_index, widths=0.5, showmeans=True,
                       )
    ax[i_m].scatter(df_all_mins['actual_EER_index'], df_all_mins[f'EER_index_{m.replace("relative", "rel")}'])
    ax[i_m].set_aspect('equal')





df_best_scale = pd.merge(df_all_mins[['col', 'ks', 'scale_ks']].groupby('col').mean().reset_index(),
         df_all_mins[['col', 'chi2', 'scale_chi2']].groupby('col').mean().reset_index(),
         on='col')

common_cols = ['bird_name', 'col', 'scale']

df_ks_min_per_scale = pd.merge(df_ks,
                     df_ks[common_cols + ['ks']].groupby(common_cols).agg(
                         best_index=('ks', 'idxmin')).reset_index().drop(columns=common_cols),
         left_index=True, right_on='best_index')


df_chi2_min_per_scale = pd.merge(df_ks,
                     df_ks[common_cols + ['chi2']].groupby(common_cols).agg(
                         best_index=('chi2', 'idxmin')).reset_index().drop(columns=common_cols),
         left_index=True, right_on='best_index')
df_rel_entropy_bird_eer_min_per_scale = pd.merge(df_ks,
                     df_ks[common_cols + ['relative_entropy_bird_eer']].groupby(common_cols).agg(
                         best_index=('relative_entropy_bird_eer', 'idxmin')).reset_index().drop(columns=common_cols),
         left_index=True, right_on='best_index')
df_rel_entropy_eer_bird_min_per_scale = pd.merge(df_ks,
                     df_ks[common_cols + ['relative_entropy_eer_bird']].groupby(common_cols).agg(
                         best_index=('relative_entropy_eer_bird', 'idxmin')).reset_index().drop(columns=common_cols),
         left_index=True, right_on='best_index')

df_ks_min_per_scale.rename(columns={'EER_index': 'EER_index_ks'}, inplace=True)
df_chi2_min_per_scale.rename(columns={'EER_index': 'EER_index_chi2'}, inplace=True)
df_rel_entropy_bird_eer_min_per_scale.rename(columns={'EER_index': 'EER_index_rel_entropy_bird_eer'}, inplace=True)
df_rel_entropy_eer_bird_min_per_scale.rename(columns={'EER_index': 'EER_index_rel_entropy_eer_bird'}, inplace=True)


df_all_mins_per_scale = pd.merge(df_ks_min_per_scale[common_cols + ['EER_index_ks',  'ks', 'ks_pvalue', 'ks_location', 'ks_sign']],
                       df_chi2_min_per_scale[common_cols + ['EER_index_chi2', 'chi2']], on=common_cols)

df_all_mins_per_scale = pd.merge(df_all_mins_per_scale,
                       df_rel_entropy_bird_eer_min_per_scale[common_cols + ['EER_index_rel_entropy_bird_eer',  'relative_entropy_bird_eer']], on=common_cols)
df_all_mins_per_scale = pd.merge(df_all_mins_per_scale,
                       df_rel_entropy_eer_bird_min_per_scale[common_cols + ['EER_index_rel_entropy_eer_bird',  'relative_entropy_eer_bird']], on=common_cols)








fig_curvature, ax_curvature = plt.subplots(4, 6 * 2, sharex='all', figsize=(18,9), layout='constrained')

ax = [ax_curvature[:2].flatten(),
      ax_curvature[2:].flatten(),]
for i_bird, current_bird in enumerate(list_of_birds):

    current_df_best = df_all_mins[df_all_mins['bird_name'] == current_bird]
    for i_col, col in enumerate(list_of_columns):
        current_df_best_index, current_best_scale = current_df_best.loc[current_df_best['col'] == col, ['EER_index_ks', 'scale_ks']].values[0]
        current_best_bird_hist = df_all_histograms.loc[(df_all_histograms['bird_name'] == current_bird)
                                                       & (df_all_histograms['col'] == col), ['bin_avg', 'hist']]
        current_best_eer_hist_gt = df_all_histograms_resampled_gt.loc[(df_all_histograms_resampled_gt['EER_index'] == current_df_best_index)
                                                                      & (df_all_histograms_resampled_gt['col'] == col)
                                                                      & (df_all_histograms_resampled_gt['scale'] == current_best_scale), ['bin_avg', 'hist']]
        ax[i_col][i_bird].bar(current_best_bird_hist['bin_avg'], current_best_bird_hist['hist'], width=0.008, align='center', alpha=0.5, fc='b')
        ax[i_col][i_bird].bar(current_best_eer_hist_gt['bin_avg'],
                              current_best_eer_hist_gt['hist'], width=0.008, align='center', alpha=0.5, fc='g')

        ax[i_col][i_bird].set_xlabel(xlabel_dict[col])
        ax[i_col][i_bird].set_title(current_bird + '\n' + f'{current_df_best_index:.0f}'+ f' {current_best_scale:1g}')


########################################################################################################################
########################################                PER SCALE              #########################################
########################################################################################################################
for scale in np.sort(df_all_mins_per_scale['scale'].unique()):
    fig_curvature, ax_curvature = plt.subplots(4, 6 * 2, sharex='all', figsize=(18,9), layout='constrained')
    ax = [ax_curvature[:2].flatten(),
          ax_curvature[2:].flatten()]
    for i_bird, current_bird in enumerate(list_of_birds):


        current_df_best = df_all_mins_per_scale[df_all_mins_per_scale['bird_name'] == current_bird]
        for i_col, col in enumerate(list_of_columns):
            current_df_best_index = current_df_best.loc[current_df_best['col'] == col, 'EER_index_chi2'].values[0]
            current_best_bird_hist = df_all_histograms.loc[(df_all_histograms['bird_name'] == current_bird)
                                                           & (df_all_histograms['col'] == col), ['bin_avg', 'hist']]
            current_best_eer_hist_gt = df_all_histograms_resampled_gt.loc[(df_all_histograms_resampled_gt['EER_index'] == current_df_best_index)
                                                                          & (df_all_histograms_resampled_gt['col'] == col)
                                                                          & (df_all_histograms_resampled_gt['scale'] == scale), ['bin_avg', 'hist']]
            ax[i_col][i_bird].bar(current_best_bird_hist['bin_avg'], current_best_bird_hist['hist'], width=0.008, align='center', alpha=0.5, fc='b')
            ax[i_col][i_bird].bar(current_best_eer_hist_gt['bin_avg'],
                                  current_best_eer_hist_gt['hist'], width=0.008, align='center', alpha=0.5, fc='g')

            ax[i_col][i_bird].set_xlabel(xlabel_dict[col])
            ax[i_col][i_bird].set_title(current_bird + '\n' + f'{current_df_best_index:.0f}')
    fig_curvature.suptitle(f' {scale:1g}')
    plt.show(block=True)

fig_scales, ax_scales = plt.subplots(2,5)
ax_scales = ax_scales.flatten()
for i_scale, scale in enumerate(np.sort(df_all_mins_per_scale['scale'].unique())):
    ax_scales[i_scale].scatter(df_all_mins_per_scale.loc[(df_all_mins_per_scale['col'] == list_of_columns[0]) & (df_all_mins_per_scale['scale'] == scale), 'EER_index_chi2'].values,
                               df_all_mins_per_scale.loc[(df_all_mins_per_scale['col'] == list_of_columns[0]) & (df_all_mins_per_scale['scale'] == scale), 'EER_index_ks'].values)
    # ax_scales[i_scale].set_xlim((10,None))
    # ax_scales[i_scale].set_ylim((10,None))
    ax_scales[i_scale].set_aspect('equal')

fig, ax = plt.subplots(2,5, sharex='all', sharey='all', figsize=(18,9), layout='constrained')
ax = ax.flatten()
for i,s  in enumerate(np.sort(df_all_histograms_resampled_gt['scale'].unique())):
    current_best_eer_hist_gt = df_all_histograms_resampled_gt.loc[(df_all_histograms_resampled_gt['EER_index'] == 0)
                                                                  & (df_all_histograms_resampled_gt['col'] == 'curvature_bird_air_abs')
                                                                  & (df_all_histograms_resampled_gt['scale'] == s), ['bin_avg', 'hist']]
    ax[i].bar(current_best_eer_hist_gt['bin_avg'], current_best_eer_hist_gt['hist'], width=0.008, align='center', alpha=0.5, fc='g')
    ax[i].set_title(f'{s:.1f}')
    print((current_best_eer_hist_gt['hist'] * 0.008).sum())








