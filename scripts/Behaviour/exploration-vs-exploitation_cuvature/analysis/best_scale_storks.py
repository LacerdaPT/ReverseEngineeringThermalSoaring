import os.path
from pathlib import Path

import matplotlib.pyplot as plt
import numpy as np
import pandas as pd
from scipy.stats import pearsonr, PermutationMethod



save=False


base_path = 'results/behaviour/EER/histograms/storks/DEC'
save_folder = base_path
compared_against = 'GT'
df_concat                       = pd.read_csv(os.path.join(base_path, 'samples.csv'), index_col=False)
df_all_histograms               = pd.read_csv(os.path.join(base_path, 'hist_per_bird.csv'), index_col=False)
df_ks                           = pd.read_csv(os.path.join(base_path, 'metrics_best_scale_cut_01_GT.csv'), index_col=False)

df_all_histograms_resampled_gt  = pd.read_csv(f'results/behaviour/EER/histograms/templates_cut_01/{compared_against}/best_scale/hist_resampled.csv', index_col=False)

df_best = pd.read_csv('results/wing_loadings/storks/best_set_of_wing_loadings.csv', index_col=False)

df_delays = pd.read_csv('data_pedro/stork_individual_data.csv', index_col=False)
df_delays.rename(columns={'Name':'bird_name'}, inplace=True)
list_bird_TM_sorted = df_delays['AvrTM(s)']


if save:
    os.makedirs(save_folder, exist_ok=True)


list_of_thermals = ['b010_0.1', 'b023_0.1',  'b072_0.1', 'b077_0.1', 'b112_0.2', 'b121_0.1']
list_of_birds = df_concat['bird_name'].sort_values().unique()
list_of_EER = sorted(df_all_histograms_resampled_gt['EER_index'].unique())
list_of_columns = df_ks['col'].unique()


my_bins = np.sort(np.unique(df_all_histograms_resampled_gt[['bin_min', 'bin_max']].values))


df_ks_min = pd.merge(df_ks,
                     df_ks[['bird_name', 'col','ks']].groupby(['bird_name', 'col']).agg(
                         best_index=('ks', 'idxmin')).reset_index().drop(columns=['bird_name', 'col']),
         left_index=True, right_on='best_index')


df_chi2_min = pd.merge(df_ks,
                     df_ks[['bird_name', 'col','chi2']].groupby(['bird_name', 'col']).agg(
                         best_index=('chi2', 'idxmin')).reset_index().drop(columns=['bird_name', 'col']),
         left_index=True, right_on='best_index')
df_rel_entropy_bird_eer_min = pd.merge(df_ks,
                     df_ks[['bird_name', 'col','relative_entropy_bird_eer']].groupby(['bird_name', 'col']).agg(
                         best_index=('relative_entropy_bird_eer', 'idxmin')).reset_index().drop(columns=['bird_name', 'col']),
         left_index=True, right_on='best_index')
df_rel_entropy_eer_bird_min = pd.merge(df_ks,
                     df_ks[['bird_name', 'col','relative_entropy_eer_bird']].groupby(['bird_name', 'col']).agg(
                         best_index=('relative_entropy_eer_bird', 'idxmin')).reset_index().drop(columns=['bird_name', 'col']),
         left_index=True, right_on='best_index')

df_ks_min.rename(columns={'EER_index': 'EER_index_ks'}, inplace=True)
df_chi2_min.rename(columns={'EER_index': 'EER_index_chi2'}, inplace=True)
df_rel_entropy_bird_eer_min.rename(columns={'EER_index': 'EER_index_rel_entropy_bird_eer'}, inplace=True)
df_rel_entropy_eer_bird_min.rename(columns={'EER_index': 'EER_index_rel_entropy_eer_bird'}, inplace=True)
df_ks_min.rename(columns={'scale': 'scale_ks'}, inplace=True)
df_chi2_min.rename(columns={'scale': 'scale_chi2'}, inplace=True)
df_rel_entropy_bird_eer_min.rename(columns={'scale': 'scale_rel_entropy_bird_eer'}, inplace=True)
df_rel_entropy_eer_bird_min.rename(columns={'scale': 'scale_rel_entropy_eer_bird'}, inplace=True)

common_cols = ['bird_name', 'col']
df_all_mins = pd.merge(df_ks_min[common_cols + ['EER_index_ks', 'scale_ks', 'ks', 'ks_pvalue', 'ks_location', 'ks_sign']],
                       df_chi2_min[common_cols + ['EER_index_chi2', 'scale_chi2','chi2']], on=common_cols)

df_all_mins = pd.merge(df_all_mins,
                       df_rel_entropy_bird_eer_min[common_cols + ['EER_index_rel_entropy_bird_eer', 'scale_rel_entropy_bird_eer', 'relative_entropy_bird_eer']], on=common_cols)
df_all_mins = pd.merge(df_all_mins,
                       df_rel_entropy_eer_bird_min[common_cols + ['EER_index_rel_entropy_eer_bird', 'scale_rel_entropy_eer_bird', 'relative_entropy_eer_bird']], on=common_cols)


df_all_mins_with_WL = pd.merge(df_all_mins,df_delays[['bird_name', 'AvrTM(s)']], on='bird_name', how='left')
df_all_mins_with_WL = pd.merge(df_all_mins_with_WL,df_best[['bird_name', 'WL_mode_avg']], on='bird_name', how='left')

list_of_pearson = []
for i_idx, idx_col in enumerate( ['EER_index_ks','EER_index_chi2', 'EER_index_rel_entropy_bird_eer']):
    for i_col, col  in enumerate( ['AvrTM(s)', 'WL_mode_avg']):
        current_data = df_all_mins_with_WL.loc[ (df_all_mins_with_WL[idx_col] > 9)
                                                & (df_all_mins_with_WL['col'] == 'curvature_bird_air_abs')
                                                & (~df_all_mins_with_WL[col].isna()), [idx_col,col]].values
        p_result = pearsonr(current_data[:,0], current_data[:,1], method=PermutationMethod(10000,10000))
        list_of_pearson.append([idx_col, col, p_result.statistic, p_result.pvalue, current_data.shape[0], ])

df_pearson = pd.DataFrame(list_of_pearson, columns=['EER_index_col', 'col', 'pearsonr', 'pvalue', 'n'])

if save:
    df_pearson.to_csv(os.path.join(save_folder,'metrics_best_scale_cut_01_GT_pearson.csv'), index=False)
    df_all_mins.to_csv(os.path.join(save_folder,'metrics_best_scale_cut_01_GT_mins.csv'), index=False)
    df_all_mins_with_WL.to_csv(os.path.join(save_folder,'metrics_best_scale_cut_01_GT_mins_with_WL.csv'), index=False)


