import os.path
import numpy as np
import pandas as pd
from scipy.stats import PermutationMethod, pearsonr

save=True

base_path = 'results/behaviour/EER/histograms/multiple_flock_behaviour_exploration/DEC'
save_folder = base_path
compared_against = 'GT'
df_concat                       = pd.read_csv(os.path.join(base_path, 'samples.csv'), index_col=False)
df_all_histograms               = pd.read_csv(os.path.join(base_path, 'hist_per_bird.csv'), index_col=False)
df_ks                           = pd.read_csv(os.path.join(base_path, f'metrics_cut_01_{compared_against}.csv'), index_col=False)

df_all_histograms_resampled_gt  = pd.read_csv(f'results/behaviour/EER/histograms/templates_cut_01/{compared_against}/hist_resampled.csv', index_col=False)


if save:
    os.makedirs(save_folder, exist_ok=True)

list_of_birds = df_ks['bird_name'].sort_values().unique()
list_of_EER = sorted(df_all_histograms_resampled_gt['EER_index'].unique())
my_bins = np.sort(np.unique(df_all_histograms_resampled_gt[['bin_min', 'bin_max']].values))
########################################################################################################################
###############################################             BEST SCALE        ##########################################
########################################################################################################################
list_of_metrics = ['ks', 'chi2', 'relative_entropy_bird_eer',
                           'relative_entropy_eer_bird']
list_of_scales = np.sort(df_ks['scale'].unique())
list_of_columns = np.sort(df_ks['col'].unique())


df_best_scale = df_ks[ ['col', 'scale']  + list_of_metrics].groupby(['col', 'scale']).agg(**{f'{col}_{stat}': (col, stat)
                                                                                             for col in list_of_metrics
                                                                                             for stat in ['mean', 'median', 'std', 'sem', 'count']}).reset_index()

df_ks = df_ks[df_ks['scale'] == 1.0]

df_ks_min = pd.merge(df_ks,
                     df_ks[['bird_name', 'col','ks']].groupby(['bird_name', 'col']).agg(
                         best_index=('ks', 'idxmin')).reset_index().drop(columns=['bird_name', 'col']),
         left_index=True, right_on='best_index')


df_chi2_min = pd.merge(df_ks,
                     df_ks[['bird_name', 'col','chi2']].groupby(['bird_name', 'col']).agg(
                         best_index=('chi2', 'idxmin')).reset_index().drop(columns=['bird_name', 'col']),
         left_index=True, right_on='best_index')
df_rel_entropy_bird_eer_min = pd.merge(df_ks,
                     df_ks[['bird_name', 'col','relative_entropy_bird_eer']].groupby(['bird_name', 'col']).agg(
                         best_index=('relative_entropy_bird_eer', 'idxmin')).reset_index().drop(columns=['bird_name', 'col']),
         left_index=True, right_on='best_index')
df_rel_entropy_eer_bird_min = pd.merge(df_ks,
                     df_ks[['bird_name', 'col','relative_entropy_eer_bird']].groupby(['bird_name', 'col']).agg(
                         best_index=('relative_entropy_eer_bird', 'idxmin')).reset_index().drop(columns=['bird_name', 'col']),
         left_index=True, right_on='best_index')

df_ks_min.rename(columns={'EER_index': 'EER_index_ks'}, inplace=True)
df_chi2_min.rename(columns={'EER_index': 'EER_index_chi2'}, inplace=True)
df_rel_entropy_bird_eer_min.rename(columns={'EER_index': 'EER_index_rel_entropy_bird_eer'}, inplace=True)
df_rel_entropy_eer_bird_min.rename(columns={'EER_index': 'EER_index_rel_entropy_eer_bird'}, inplace=True)
df_ks_min.rename(columns={'scale': 'scale_ks'}, inplace=True)
df_chi2_min.rename(columns={'scale': 'scale_chi2'}, inplace=True)
df_rel_entropy_bird_eer_min.rename(columns={'scale': 'scale_rel_entropy_bird_eer'}, inplace=True)
df_rel_entropy_eer_bird_min.rename(columns={'scale': 'scale_rel_entropy_eer_bird'}, inplace=True)

common_cols = ['bird_name', 'col']
df_all_mins = pd.merge(df_ks_min[common_cols + ['actual_EER_index', 'EER'] + ['EER_index_ks', 'scale_ks', 'ks', 'ks_pvalue', 'ks_location', 'ks_sign']],
                        df_chi2_min[common_cols + ['EER_index_chi2', 'scale_chi2','chi2']], on=common_cols)

df_all_mins = pd.merge(df_all_mins,
                       df_rel_entropy_bird_eer_min[common_cols + ['EER_index_rel_entropy_bird_eer', 'scale_rel_entropy_bird_eer', 'relative_entropy_bird_eer']], on=common_cols)
df_all_mins = pd.merge(df_all_mins,
                       df_rel_entropy_eer_bird_min[common_cols + ['EER_index_rel_entropy_eer_bird', 'scale_rel_entropy_eer_bird', 'relative_entropy_eer_bird']], on=common_cols)


df_all_mins['delta_EER_index_ks'] = df_all_mins['EER_index_ks'] - df_all_mins['actual_EER_index']
df_all_mins['delta_EER_index_chi2'] = df_all_mins['EER_index_chi2'] - df_all_mins['actual_EER_index']
df_all_mins['delta_EER_index_rel_entropy_bird_eer'] = df_all_mins['EER_index_rel_entropy_bird_eer'] - df_all_mins['actual_EER_index']




list_of_pearson = []
for i_col, col in enumerate(list_of_columns):
    current_all_mins = df_all_mins[df_all_mins['col'] == col]
    for i_idx, idx_col in enumerate( ['EER_index_ks',
                                      'EER_index_chi2', 'EER_index_rel_entropy_bird_eer']):
        current_data = current_all_mins.loc[ current_all_mins[idx_col] > -1, ['actual_EER_index',idx_col]].values
        p_result = pearsonr(current_data[:,0], current_data[:,1], method=PermutationMethod(1000,1000))
        list_of_pearson.append(['actual_EER_index', idx_col.replace('EER_index_', ''), col, p_result.statistic, p_result.pvalue, current_data.shape[0], ])

df_pearson = pd.DataFrame(list_of_pearson, columns=['actual_EER_index','metric', 'col', 'pearsonr', 'pvalue', 'n'])


if save:
    df_pearson.to_csv(os.path.join(base_path, f'metrics_cut_01_GT_pearson.csv'), index=False)
    df_all_mins.to_csv(os.path.join(base_path, f'metrics_cut_01_GT_mins.csv'), index=False)