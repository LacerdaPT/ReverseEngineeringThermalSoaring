import copy
import os.path
from pathlib import Path

import matplotlib
import matplotlib.pyplot as plt
import numpy as np
import pandas as pd
from matplotlib.cm import ScalarMappable
from matplotlib.colors import Normalize
from scipy import stats
from scipy.interpolate import CubicSpline
from scipy.special import rel_entr
from scipy.stats import kde, ks_2samp, kstest, gaussian_kde

from calc.auxiliar import get_smoothed_diff_per_partition, get_geometric_characteristics, UnivariateSplineWrapper
from data.get_data import load_synthetic_and_decomposed, load_synthetic_data, load_decomposition_data
save=True
path_to_root = 'synthetic_data/from_atlasz/newdata/storks'
glob_string = 'b*'
datatype = 'DEC'
save_folder = f'results/behaviour/EER/histograms/storks/{datatype}'
save_concat_filename = 'samples.csv'
save_hist_per_bird_filename = 'hist_per_bird.csv'


list_of_cols = ['curvature_bird_air_abs','curvature_bird_ground_abs']
my_bins = np.linspace(0, 0.2, 26)

bin_avgs = (my_bins[0:-1] + my_bins[1:]) / 2


if save:
    os.makedirs(save_folder, exist_ok=True)
parameter_dict_lambda = lambda p: {'realization': p.parents[4].name,
                                   'parameter_name': p.parents[0].name.split('=')[0],
                                   'parameter_value': float(p.parents[0].name.split('=')[1]),
                                   'sweep_type': p.parents[1].name}


df_concat = pd.DataFrame()

bin_size = 2
p=Path(path_to_root)


rho_col = 'rho_bird_TC'
list_of_thermals = ['b010_0.1', 'b023_0.1',  'b072_0.1', 'b077_0.1', 'b112_0.2', 'b121_0.1']
for i_realization, current_thermal in enumerate(list_of_thermals):

    path_to_decomposition = os.path.join(path_to_root, current_thermal, 'decomposition/individual_bins/bin_z_size=10/optimized/n_resamples=1000/final/reconstructed')

    dec = load_decomposition_data(path_to_decomposition,list_of_files=['iterations.csv', 'splines.yaml'])
    df = dec['iterations']

    df = df[df['in_hull'] & (~df['interpolated']) & (np.abs(df['curvature']) < 0.1)].copy()
    diff = get_smoothed_diff_per_partition(df, {
                                                f'dXdT_bird_ground': None,
                                                f'dYdT_bird_ground': None,
                                                f'dZdT_bird_ground': None} ,
                                           dt=1,
                                           method='5point',
                                           partition_key='bird_name')
    df['d2XdT2_bird_ground'] = diff['dXdT_bird_ground']
    df['d2YdT2_bird_ground'] = diff['dYdT_bird_ground']
    df['d2ZdT2_bird_ground'] = diff['dZdT_bird_ground']
    df_calc = get_geometric_characteristics(df,
        state_vector_columns = {'Vx': 'dXdT_bird_ground',
                                'Vy': 'dYdT_bird_ground',
                                'Ax': 'd2XdT2_bird_ground',
                                'Ay': 'd2YdT2_bird_ground'})
    df_calc = df_calc[['bird_name', 'time', 'curvature']]
    df_calc.rename(columns={'curvature': 'curvature_bird_ground'}, inplace=True)
    df.rename(columns={'curvature': 'curvature_bird_air'}, inplace=True)
    df = pd.merge(df, df_calc, on=['bird_name', 'time'])


    diff = get_smoothed_diff_per_partition(df, {'curvature_bird_air':None,
                                                'curvature_bird_ground': None},
                                           dt=1,
                                           method='5point',
                                           partition_key='bird_name')

    df['dKdT_bird_air'] = diff['curvature_bird_air']
    df['dKdT_bird_ground'] = diff['curvature_bird_ground']

    df['dKdT_bird_air_abs'] = np.abs(df['dKdT_bird_air'])
    df['dKdT_bird_ground_abs'] = np.abs(df['dKdT_bird_ground'])
    df['curvature_bird_air_abs'] = np.abs(df['curvature_bird_air'])
    df['curvature_bird_ground_abs'] = np.abs(df['curvature_bird_ground'])


    df['thermal'] = current_thermal

    df_concat = pd.concat([df_concat, df])



if save:
    df_concat.to_csv(os.path.join(save_folder, save_concat_filename),
                     index=False)
list_of_birds = df_concat['bird_name'].sort_values().unique()



df_all_histograms_dec_per_bird = pd.DataFrame()

for i_col, col in enumerate(list_of_cols):

    for i_bird, current_bird in enumerate(list_of_birds):
        current_df_bird_col = df_concat.loc[df_concat['bird_name'] == current_bird, col].values.astype(float)

        if df_all_histograms_dec_per_bird.empty or df_all_histograms_dec_per_bird[(df_all_histograms_dec_per_bird['bird_name'] == current_bird)
                                                                                  & (df_all_histograms_dec_per_bird['col'] == col)].empty:
            current_bird_histogram, _ = np.histogram(current_df_bird_col, my_bins, density=True)

            current_df_bird_histograms = np.stack([my_bins[0:-1],
                                              my_bins[1:],
                                                   (my_bins[0:-1] + my_bins[1:]) / 2,
                                                   current_bird_histogram],
                                                  axis=-1)
            current_df_bird_histograms = pd.DataFrame(current_df_bird_histograms,
                                                 columns=['bin_min', 'bin_max', 'bin_avg', 'hist'])
            current_df_bird_histograms['bird_name'] = current_bird
            current_df_bird_histograms['col'] = col

            df_all_histograms_dec_per_bird = pd.concat([df_all_histograms_dec_per_bird, current_df_bird_histograms])
            current_bird_hist = current_bird_histogram.copy()
if save:
    df_all_histograms_dec_per_bird.to_csv(os.path.join(save_folder, save_hist_per_bird_filename), index=False)
