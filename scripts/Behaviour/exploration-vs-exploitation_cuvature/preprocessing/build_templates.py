
import os.path
from pathlib import Path

import matplotlib.pyplot as plt
import numpy as np
import pandas as pd

from scipy.stats import gaussian_kde

from calc.auxiliar import get_smoothed_diff_per_partition, get_geometric_characteristics
from data.get_data import  load_synthetic_data, load_decomposition_data
save=True
path_to_gt_root = 'synthetic_data/from_atlasz/newdata/'
glob_string = 'EER_sweep_*/EER*/*'
datatype = 'GT'
save_folder = f'results/behaviour/EER/histograms/templates_cut_01/{datatype}/best_scale'
save_concat_filename = 'samples.csv'
save_hist_per_bird_filename = 'hist_per_bird.csv'
save_hist_filename = 'hist.csv'
save_hist_resampled_filename = 'hist_resampled.csv'
if save:
    os.makedirs(save_folder, exist_ok=True)
parameter_dict_lambda = lambda p: {'realization': p.name,
                                   'parameter_name': p.parents[0].name.split('=')[0],
                                   'parameter_value': float(p.parents[0].name.split('=')[1]),
                                   'sweep_type': p.parents[1].name}
df_pearson = []
df_concat = pd.DataFrame()
df_binned_concat  = pd.DataFrame()
bin_size = 2
list_of_scales = [0.675] # np.round(np.arange(0.5, 1.5, 0.1), 1)
my_bins = np.linspace(0, 0.2, 26)
EER_bins = np.linspace(0,1,21, endpoint=True)

bin_avgs = (my_bins[:-1] + my_bins[1:]) / 2

p=Path(path_to_gt_root)
for i_realization, s in enumerate(p.glob(glob_string)):
    path_to_synthetic = str(s)
    path_to_decomposition = os.path.join(path_to_synthetic, 'decomposition/average/0/final/reconstructed')

    dec = load_decomposition_data(path_to_decomposition,list_of_files=['iterations.csv', 'splines.yaml'])
    syn = load_synthetic_data(path_to_synthetic, list_of_object=['data_full.csv', 'bird_parameters.csv'])

    df_birds = syn['bird_parameters']

    if datatype == 'DEC':

        df = dec['iterations']
        df = df[df['in_hull'] & (~df['interpolated']) & (np.abs(df['curvature']) < 0.1)].copy()
        diff = get_smoothed_diff_per_partition(df, {
            f'dXdT_bird_ground': None,
            f'dYdT_bird_ground': None,
            f'dZdT_bird_ground': None},
                                               dt=1,
                                               method='5point',
                                               partition_key='bird_name')
        df['d2XdT2_bird_ground'] = diff['dXdT_bird_ground']
        df['d2YdT2_bird_ground'] = diff['dYdT_bird_ground']
        df['d2ZdT2_bird_ground'] = diff['dZdT_bird_ground']
        df_calc = get_geometric_characteristics(df,
                                                state_vector_columns={'Vx': 'dXdT_bird_ground',
                                                                      'Vy': 'dYdT_bird_ground',
                                                                      'Ax': 'd2XdT2_bird_ground',
                                                                      'Ay': 'd2YdT2_bird_ground'})
        df_calc = df_calc[['bird_name', 'time', 'curvature']]
        df_calc.rename(columns={'curvature': 'curvature_bird_ground'}, inplace=True)
        df.rename(columns={'curvature': 'curvature_bird_air'}, inplace=True)
        df = pd.merge(df, df_calc, on=['bird_name', 'time'])

    else:
        df_thermal = pd.read_csv(os.path.join(path_to_decomposition, 'ground_truth_reconstructed', 'thermal.csv'))
        df = syn['data_full']
        df = df[df['time']> 20].copy()
    diff = get_smoothed_diff_per_partition(df, {'curvature_bird_air':None,
                                                'curvature_bird_ground': None},
                                           dt=1,
                                           method='5point',
                                           partition_key='bird_name')
    df['dKdT_bird_air'] = diff['curvature_bird_air']
    df['dKdT_bird_ground'] = diff['curvature_bird_ground']

    df['dKdT_bird_air_abs'] = np.abs(df['dKdT_bird_air'])
    df['dKdT_bird_ground_abs'] = np.abs(df['dKdT_bird_ground'])
    df['curvature_bird_air_abs'] = np.abs(df['curvature_bird_air'])
    df['curvature_bird_ground_abs'] = np.abs(df['curvature_bird_ground'])
    for k,v in parameter_dict_lambda(s).items():
        df[k] = v

    df['path_to_synthetic'] = '/'.join(path_to_synthetic.split("/")[-3:]) + '/' + df['bird_name']

    df = pd.merge(df, df_birds[['bird_name', 'control_parameters.general_args.exploration_exploitation_ratio']], on='bird_name')
    df_concat = pd.concat([df_concat, df])





df_concat.rename(columns={'control_parameters.general_args.exploration_exploitation_ratio': 'EER'}, inplace=True)
df_concat['EER_index'] = np.digitize(df_concat['EER'], EER_bins) - 1

df_concat['EER_min'] = EER_bins[df_concat['EER_index'] ]
df_concat['EER_max'] = EER_bins[df_concat['EER_index']  + 1]
df_concat['EER_avg'] = (df_concat['EER_max'] + df_concat['EER_min']) / 2

list_of_cols = ['curvature_bird_air_abs', 'curvature_bird_ground_abs']

list_of_EER = np.sort(df_concat['EER_index'].unique())
if save:
    df_concat.to_csv(os.path.join(save_folder, save_concat_filename),
                     index=False)



df_all_histograms_dec_per_bird = pd.DataFrame()
list_of_birds = np.sort(df_concat['path_to_synthetic'].unique())
for i_realization, realization in enumerate(list_of_birds):
    currenf_df_realization = df_concat[df_concat['path_to_synthetic'] == realization]
    if currenf_df_realization.empty:
        continue

    for i_col, col in enumerate(list_of_cols):
        print(col, realization)
        my_histogram, _ = np.histogram(currenf_df_realization[col], my_bins, density=True)

        current_df_histograms = np.stack([my_bins[0:-1],
                                          my_bins[1:],
                                          (my_bins[0:-1] + my_bins[1:])/2,
                                          my_histogram],
                                         axis=-1)
        current_df_histograms = pd.DataFrame(current_df_histograms, columns=['bin_min', 'bin_max', 'bin_avg', 'hist'])
        current_df_histograms['path_to_synthetic'] = realization
        current_df_histograms['EER_index'] = currenf_df_realization['EER_index'].unique()[0]
        current_df_histograms['EER_min'] = currenf_df_realization['EER_min'].unique()[0]
        current_df_histograms['EER_max'] = currenf_df_realization['EER_max'].unique()[0]
        current_df_histograms['EER_avg'] = currenf_df_realization['EER_avg'].unique()[0]
        current_df_histograms['EER'] = currenf_df_realization['EER'].unique()[0]
        current_df_histograms['col'] = col
        df_all_histograms_dec_per_bird = pd.concat([df_all_histograms_dec_per_bird, current_df_histograms])


if save:
    df_all_histograms_dec_per_bird.to_csv(os.path.join(save_folder, save_hist_per_bird_filename), index=False)


df_all_histograms = pd.DataFrame()
df_all_histograms_resampled = pd.DataFrame()
for i_col, col in enumerate(list_of_cols):
    for current_eer in list_of_EER:
        current_df_eer = df_concat.loc[df_concat['EER_index'] == current_eer, col].values.astype(float)

        current_hist, _ = np.histogram(current_df_eer, my_bins, density=True)

        current_df_histogram = np.stack([my_bins[0:-1],
                                                   my_bins[1:],
                                                   bin_avgs,
                                                   current_hist],
                                                  axis=-1)
        current_df_histogram = pd.DataFrame(current_df_histogram,
                                                      columns=['bin_min', 'bin_max', 'bin_avg', 'hist'])

        current_df_histogram['EER_index'] = current_eer
        current_df_histogram['col'] = col
        df_all_histograms = pd.concat([df_all_histograms, current_df_histogram])
        for scale in list_of_scales:
            print(col, current_eer, scale)
            current_scaled_df_eer = scale * current_df_eer
            current_kde_gt = gaussian_kde(current_scaled_df_eer[current_scaled_df_eer < 0.1])
            def my_cdf(high):
                return current_kde_gt.integrate_box_1d(0, high )

            my_cdf = np.vectorize(my_cdf)

            current_resampled_hist = current_kde_gt(bin_avgs)
            current_df_resampled_histogram = np.stack([my_bins[0:-1],
                                              my_bins[1:],
                                              bin_avgs,
                                              current_resampled_hist],
                                             axis=-1)
            current_df_resampled_histogram = pd.DataFrame(current_df_resampled_histogram,
                                                 columns=['bin_min', 'bin_max', 'bin_avg', 'hist'])

            current_df_resampled_histogram['EER_index'] = current_eer
            current_df_resampled_histogram['col'] = col
            current_df_resampled_histogram['scale'] = scale
            df_all_histograms_resampled = pd.concat([df_all_histograms_resampled, current_df_resampled_histogram])
if save:
    df_all_histograms.to_csv(os.path.join(save_folder, save_hist_filename), index=False)
    df_all_histograms_resampled.to_csv(os.path.join(save_folder, save_hist_resampled_filename), index=False)


fig, ax = plt.subplots(4,5, sharex='all')
ax = ax.flatten()
for i_eer, current_eer in enumerate(list_of_EER):
    current_best_eer_hist_gt = df_all_histograms.loc[(df_all_histograms['EER_index'] == current_eer)
                                                 & (df_all_histograms['col'] == 'curvature_bird_air_abs'),['bin_avg', 'hist']]
    current_best_eer_hist_gt_resampled = df_all_histograms_resampled.loc[(df_all_histograms_resampled['EER_index'] == current_eer)
                                                 & (df_all_histograms_resampled['col'] == 'curvature_bird_air_abs')
                                                 & (df_all_histograms_resampled['scale'] == 1.0),['bin_avg', 'hist']]
    ax[i_eer].bar(current_best_eer_hist_gt['bin_avg'],
                              current_best_eer_hist_gt['hist'], width=0.008, align='center', alpha=0.5, fc='b')
    ax[i_eer].bar(current_best_eer_hist_gt_resampled['bin_avg'],
                              current_best_eer_hist_gt_resampled['hist'], width=0.008, align='center', alpha=0.5, fc='g')
    ax[i_eer].set_title(f'{current_eer:.2f}')
