
import os.path
from pathlib import Path

import numpy as np
import pandas as pd

from calc.auxiliar import get_smoothed_diff_per_partition, get_geometric_characteristics
from data.get_data import  load_synthetic_data, load_decomposition_data
save=True
path_to_gt_root = 'synthetic_data/from_atlasz/newdata/'
glob_string = 'multiple_flock_behaviour_exploration/[0-9]/[0-9]'
datatype = 'DEC'
save_folder = f'results/behaviour/EER/histograms/multiple_flock_behaviour_exploration/{datatype}'

save_concat_filename = 'samples.csv'
save_hist_per_bird_filename = 'hist_per_bird.csv'


if save:
    os.makedirs(save_folder, exist_ok=True)

df_pearson = []
df_concat = pd.DataFrame()
df_binned_concat  = pd.DataFrame()
bin_size = 2
list_of_scales = [1.0] #np.round(np.arange(0.5, 1.5, 0.1), 1)
my_bins = np.linspace(0, 0.2, 26)

bin_avgs = (my_bins[:-1] + my_bins[1:]) / 2

p=Path(path_to_gt_root)
for i_bird, s in enumerate(p.glob(glob_string)):
    path_to_synthetic = str(s)
    subflock_no = int(s.parent.name)

    path_to_decomposition = os.path.join(path_to_synthetic, 'decomposition/average/0/final/reconstructed')

    dec = load_decomposition_data(path_to_decomposition,list_of_files=['iterations.csv', 'splines.yaml'])
    syn = load_synthetic_data(path_to_synthetic, list_of_object=['data_full.csv', 'bird_parameters.csv'])

    df_birds = syn['bird_parameters']

    if datatype == 'DEC':

        df = dec['iterations']
        df = df[df['in_hull'] & (~df['interpolated']) & (np.abs(df['curvature']) < 0.1)].copy()
        diff = get_smoothed_diff_per_partition(df, {
            f'dXdT_bird_ground': None,
            f'dYdT_bird_ground': None,
            f'dZdT_bird_ground': None},
                                               dt=1,
                                               method='5point',
                                               partition_key='bird_name')
        df['d2XdT2_bird_ground'] = diff['dXdT_bird_ground']
        df['d2YdT2_bird_ground'] = diff['dYdT_bird_ground']
        df['d2ZdT2_bird_ground'] = diff['dZdT_bird_ground']
        df_calc = get_geometric_characteristics(df,
                                                state_vector_columns={'Vx': 'dXdT_bird_ground',
                                                                      'Vy': 'dYdT_bird_ground',
                                                                      'Ax': 'd2XdT2_bird_ground',
                                                                      'Ay': 'd2YdT2_bird_ground'})
        df_calc = df_calc[['bird_name', 'time', 'curvature']]
        df_calc.rename(columns={'curvature': 'curvature_bird_ground'}, inplace=True)
        df.rename(columns={'curvature': 'curvature_bird_air'}, inplace=True)
        df = pd.merge(df, df_calc, on=['bird_name', 'time'])

    else:
        df_thermal = pd.read_csv(os.path.join(path_to_decomposition, 'ground_truth_reconstructed', 'thermal.csv'))
        df = syn['data_full']
        df = df[df['time']> 20].copy()
    diff = get_smoothed_diff_per_partition(df, {'curvature_bird_air':None,
                                                'curvature_bird_ground': None},
                                           dt=1,
                                           method='5point',
                                           partition_key='bird_name')
    df['dKdT_bird_air'] = diff['curvature_bird_air']
    df['dKdT_bird_ground'] = diff['curvature_bird_ground']

    df['dKdT_bird_air_abs'] = np.abs(df['dKdT_bird_air'])
    df['dKdT_bird_ground_abs'] = np.abs(df['dKdT_bird_ground'])
    df['curvature_bird_air_abs'] = np.abs(df['curvature_bird_air'])
    df['curvature_bird_ground_abs'] = np.abs(df['curvature_bird_ground'])
    df = df[['time', 'bird_name',
             'curvature_bird_air', 'curvature_bird_ground',
             'curvature_bird_air_abs', 'curvature_bird_ground_abs',
             'dKdT_bird_air', 'dKdT_bird_ground',
             'dKdT_bird_air_abs', 'dKdT_bird_ground_abs',
             ]]
    df = pd.merge(df, df_birds[['bird_name', 'control_parameters.general_args.exploration_exploitation_ratio']], on='bird_name')
    df['old_bird_name'] = df['bird_name']
    df['bird_name'] = df['bird_name'].apply( lambda row: row.split('_')[0]
                                       + '_'
                                       + ('00' + str( 25 * subflock_no + int(row.split('_')[1])
                                              ))[-2:]
                           )
    df['thermal'] = s.name
    df_concat = pd.concat([df_concat, df])





df_concat.rename(columns={'control_parameters.general_args.exploration_exploitation_ratio': 'EER'}, inplace=True)
EER_bins = np.linspace(0,1+0.001,21, endpoint=True)
df_concat['EER_index'] = np.digitize(df_concat['EER'], EER_bins) - 1
EER_bins_min = EER_bins[:-1]
EER_bins_max = EER_bins[1:]
df_concat['EER_min'] = EER_bins_min[df_concat['EER_index'] ]
df_concat['EER_max'] = EER_bins_max[df_concat['EER_index']]
df_concat['EER_avg'] = (df_concat['EER_max'] + df_concat['EER_min']) / 2

list_of_cols = ['curvature_bird_air_abs', 'curvature_bird_ground_abs']

list_of_EER = np.sort(df_concat['EER_index'].unique())
if save:
    df_concat.to_csv(os.path.join(save_folder, save_concat_filename),
                     index=False)



df_all_histograms_dec_per_bird = pd.DataFrame()
list_of_birds = np.sort(df_concat['bird_name'].unique())
for i_bird, bird in enumerate(list_of_birds):
    currenf_df_bird = df_concat[df_concat['bird_name'] == bird]
    if currenf_df_bird.empty:
        continue

    for i_col, col in enumerate(list_of_cols):
        print(col, bird)
        my_histogram, _ = np.histogram(currenf_df_bird[col], my_bins, density=True)

        current_df_histograms = np.stack([my_bins[0:-1],
                                          my_bins[1:],
                                          (my_bins[0:-1] + my_bins[1:])/2,
                                          my_histogram],
                                         axis=-1)
        current_df_histograms = pd.DataFrame(current_df_histograms, columns=['bin_min', 'bin_max', 'bin_avg', 'hist'])
        current_df_histograms['bird_name'] = bird
        current_df_histograms['EER_index'] = currenf_df_bird['EER_index'].unique()[0]
        current_df_histograms['EER_min'] = currenf_df_bird['EER_min'].unique()[0]
        current_df_histograms['EER_max'] = currenf_df_bird['EER_max'].unique()[0]
        current_df_histograms['EER_avg'] = currenf_df_bird['EER_avg'].unique()[0]
        current_df_histograms['EER'] = currenf_df_bird['EER'].unique()[0]
        current_df_histograms['col'] = col
        df_all_histograms_dec_per_bird = pd.concat([df_all_histograms_dec_per_bird, current_df_histograms])


if save:
    df_all_histograms_dec_per_bird.to_csv(os.path.join(save_folder, save_hist_per_bird_filename), index=False)


