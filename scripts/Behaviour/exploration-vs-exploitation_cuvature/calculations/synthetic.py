import os.path

import matplotlib.pyplot as plt
import numpy as np
import pandas as pd
from scipy.special import rel_entr
from scipy.stats import kstest, gaussian_kde

from calc.post_processing.behaviour import compare_curvature_histograms

save=False
save_folder = f'results/behaviour/EER/histograms/multiple_flock_behaviour_exploration/DEC'

compare_against = 'GT'
save_metrics_filename = f'metrics_cut_01_{compare_against}.csv'



df_concat_gt                    = pd.read_csv(f'results/behaviour/EER/histograms/templates_cut_01/{compare_against}/samples.csv', index_col=False)
df_all_histograms_resampled_gt  = pd.read_csv(f'results/behaviour/EER/histograms/templates_cut_01/{compare_against}/hist_resampled.csv', index_col=False)


df_concat                       = pd.read_csv('results/behaviour/EER/histograms/multiple_flock_behaviour_exploration/DEC/samples.csv', index_col=False)
df_all_histograms               = pd.read_csv('results/behaviour/EER/histograms/multiple_flock_behaviour_exploration/DEC/hist_per_bird.csv', index_col=False)

if save:
    os.makedirs(save_folder, exist_ok=True)


list_of_scales = [1.0] # np.sort(df_all_histograms_resampled_gt['scale'].unique()) # np.arange(0.5,0.6,0.1) #
list_of_birds = df_concat['bird_name'].unique()[5:8]

list_of_EER = sorted(df_all_histograms_resampled_gt['EER_index'].unique())[5:7]

list_of_cols = ['curvature_bird_air_abs',
                'curvature_bird_ground_abs'
                ]
my_bins = np.linspace(0, 0.2, 26)

bin_avgs = (my_bins[0:-1] + my_bins[1:]) / 2

df_ks = compare_curvature_histograms(df_concat, df_all_histograms,
                                     df_concat_gt, df_all_histograms_resampled_gt,
                                     list_of_cols, list_of_birds, list_of_EER, list_of_scales, bin_avgs)

df_ks['actual_EER_index'] = df_ks['bird_name'].apply(lambda current_bird: df_concat.loc[df_concat['bird_name'] == current_bird, 'EER_index'].unique()[0])
df_ks['EER'] = df_ks['bird_name'].apply(lambda current_bird: df_concat.loc[df_concat['bird_name'] == current_bird, 'EER'].unique()[0])

if save:
    df_ks.to_csv(os.path.join(save_folder, save_metrics_filename), index=False)

