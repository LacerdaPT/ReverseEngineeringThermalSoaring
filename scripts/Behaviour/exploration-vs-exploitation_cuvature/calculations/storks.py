
import os.path
from pathlib import Path

import numpy as np
import pandas as pd
from scipy.special import rel_entr
from scipy.stats import kstest, gaussian_kde

from calc.post_processing.behaviour import compare_curvature_histograms

save=True
path_to_gt_root = 'synthetic_data/from_atlasz/newdata/storks'
glob_string = 'b*'
save_folder = f'results/behaviour/EER/histograms/storks/DEC'


compare_against = 'GT'
save_metrics_filename = f'metrics_best_scale_cut_01_{compare_against}.csv'



df_concat_gt                    = pd.read_csv(f'results/behaviour/EER/histograms/templates_cut_01/{compare_against}/best_scale/samples.csv', index_col=False)
df_all_histograms_resampled_gt  = pd.read_csv(f'results/behaviour/EER/histograms/templates_cut_01/{compare_against}/best_scale/hist_resampled.csv', index_col=False)


df_concat                       = pd.read_csv('results/behaviour/EER/histograms/storks/DEC/samples.csv', index_col=False)
df_all_histograms               = pd.read_csv('results/behaviour/EER/histograms/storks/DEC/hist_per_bird.csv', index_col=False)

if save:
    os.makedirs(save_folder, exist_ok=True)

#This is the mean scale of the best matches according to chi2
list_of_scales = [0.675] # np.sort(df_all_histograms_resampled_gt['scale'].unique()) # np.arange(0.5,0.6,0.1) #

list_of_cols = ['curvature_bird_air_abs',
                'curvature_bird_ground_abs']
my_bins = np.linspace(0, 0.2, 26)

bin_avgs = (my_bins[0:-1] + my_bins[1:]) / 2


list_of_birds = np.sort(df_concat['bird_name'].unique())
list_of_EER = sorted(df_all_histograms_resampled_gt['EER_index'].unique())

df_ks = compare_curvature_histograms(df_concat, df_all_histograms, df_concat_gt, df_all_histograms_resampled_gt,
                                     list_of_cols, list_of_birds, list_of_EER, list_of_scales, bin_avgs)
if save:
    df_ks.to_csv(os.path.join(save_folder, save_metrics_filename), index=False)

