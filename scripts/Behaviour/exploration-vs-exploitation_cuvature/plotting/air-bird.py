import os
import shelve

import numpy as np
from dill import Pickler, Unpickler
from matplotlib import pyplot as plt
from matplotlib.cm import ScalarMappable
from matplotlib.colors import CenteredNorm, Normalize
from scipy import stats
from scipy.spatial import KDTree
from scipy.stats import PermutationMethod

from calc.auxiliar import cart_to_cyl_point, cart_to_cyl_matrix, get_smoothed_diff_per_partition
from data.get_data import load_decomposition_data
from object.air import ReconstructedAirVelocityField


shelve.Pickler = Pickler
shelve.Unpickler = Unpickler

path_to_files = 'synthetic_data/from_atlasz/newdata/storks/b010_0.1/decomposition/individual_bins/bin_z_size=10/optimized/n_resamples=1000/final/reconstructed' # 'synthetic_data/wobblythermal/_2025-01-30T14:13:37/decomposition/final/reconstructed'
dec = load_decomposition_data(path_to_files, list_of_files=['iterations.csv', 'splines.yaml'], iteration='best')
df_dec = dec['iterations']
df_splines = dec['splines'][0]

avf_decomposed = ReconstructedAirVelocityField.from_path(path_to_files=path_to_files, max_extrapolated_distance=20,)

avf_decomposed.get_velocity([-17,-0, 400], relative_to_ground=False, include='thermal')
z_lims = [np.min(df_splines['wind']['wind_X']['tck'][0]),
          np.max(df_splines['wind']['wind_X']['tck'][0])]

diff_params = {'dXdT_air_ground':   None,
               'dYdT_air_ground':   None,
               'dZdT_air_ground':   None,
               'curvature': None,
               'bank_angle': None,
               'radius': None}
diff_results = get_smoothed_diff_per_partition(df_dec, diff_params, n=1, dt=1, partition_key='bird_name')

df_dec['curvature_abs'] = np.abs(df_dec['curvature'])
df_dec['bank_angle_abs'] = np.abs(df_dec['bank_angle'])

df_dec['d2XdT2_air_ground'] = diff_results['dXdT_air_ground']
df_dec['d2YdT2_air_ground'] = diff_results['dYdT_air_ground']
df_dec['d2ZdT2_air_ground'] = diff_results['dZdT_air_ground']
df_dec['dcurvaturedT'] = diff_results['curvature']
df_dec['dbank_angledT'] = diff_results['bank_angle']
df_dec['dradiusdT'] = diff_results['radius']
df_dec = df_dec[df_dec['Z'].between(*z_lims)]
df_dec = df_dec[df_dec['curvature_abs'] < 0.1]
fig, ax = plt.subplots(2,4, layout='constrained', figsize=(12,6))
for i_1, col1 in enumerate(['dZdT_air_ground', 'd2ZdT2_air_ground']):
    for i_2, col2 in enumerate(['bank_angle_abs', 'curvature_abs', 'dbank_angledT', 'dcurvaturedT']):
        df_calc = df_dec[(~df_dec[col1].isna()) & ~df_dec[col2].isna()]
        p = stats.pearsonr(df_calc[col1], df_calc[col2]) # , method=PermutationMethod(batch=9999)
        ax[i_1, i_2].scatter(df_calc[col1], df_calc[col2], alpha=0.3)
        ax[i_1, i_2].set_title(f'pearson r={p.statistic:.3f}')
        ax[i_1, i_2].set_xlabel(col1)
        ax[i_1, i_2].set_ylabel(col2)







with shelve.open(os.path.join(path_to_files,'interpolators')) as d:
# with shelve.open(os.path.join(path_to_files, 'interpolators')) as d:
    current_interpolator_dict = d[str(1)]