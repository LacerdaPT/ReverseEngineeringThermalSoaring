import os
import numpy as np
import pandas as pd
from matplotlib.cm import ScalarMappable

from misc.config import science_matplotlib_config
from plotting.auxiliar import simple_axis

save=True
figsize_multiplier = 2

science_matplotlib_config(figsize_multiplier, save)
import matplotlib
import matplotlib.pyplot as plt
from matplotlib.colors import Normalize

xlabel_dict = {'curvature_bird_air_abs':     '$|\\kappa_\\mathrm{bird,air}| \\ (\\mathrm{m}^{-1})$',
                'curvature_bird_ground_abs': '$|\\kappa_\\mathrm{bird,ground}| \\ (\\mathrm{m}^{-1})$',
                'dKdT_bird_air_abs':         '$|d\\kappa/d t _\\mathrm{bird,air}| \\ (\\mathrm{m}^{-1}\\mathrm{s}^{-1})$',
                'dKdT_bird_ground_abs':      '$|d\\kappa/d t _\\mathrm{bird,ground}| \\ (\\mathrm{m}^{-1}\\mathrm{s}^{-1})$', }



compared_against = 'GT'
base_path = f'results/behaviour/EER/histograms/templates_cut_01/{compared_against}/'
df_all_histograms_resampled_gt  = pd.read_csv(os.path.join(base_path, 'hist_resampled.csv'), index_col=False)

df_all_histograms_resampled_gt = df_all_histograms_resampled_gt[df_all_histograms_resampled_gt['scale'] == 1]
df_all_histograms_resampled_gt = df_all_histograms_resampled_gt[df_all_histograms_resampled_gt['bin_min'] < 0.1]
df_all_histograms_resampled_gt = df_all_histograms_resampled_gt[df_all_histograms_resampled_gt['col'] == 'curvature_bird_air_abs']


save_folder = os.path.join(base_path, 'figures')
if save:
    os.makedirs(os.path.join(save_folder,'png'), exist_ok=True)
    os.makedirs(os.path.join(save_folder, 'svg'), exist_ok=True)
list_of_EER = np.sort(df_all_histograms_resampled_gt['EER_index'].unique())

fig, ax = plt.subplots(5,4, sharex='all', sharey='all', layout='constrained',
                       figsize=(figsize_multiplier * 4.75, figsize_multiplier * 5))
ax_flat = ax.flatten()
for i_eer, current_EER_index in enumerate(list_of_EER):
    ax_flat[i_eer].bar(df_all_histograms_resampled_gt.loc[df_all_histograms_resampled_gt['EER_index'] == current_EER_index, 'bin_avg'],
               df_all_histograms_resampled_gt.loc[df_all_histograms_resampled_gt['EER_index'] == current_EER_index, 'hist'],
                       width=0.008, align='center',alpha=0.5, fc='g')
    if i_eer % ax.shape[1] == 0:
        ax_flat[i_eer].set_title(f'$EER \\in [{current_EER_index * 0.05:.2f}, {(current_EER_index + 1) * 0.05:.2f}]$')
    else:
        ax_flat[i_eer].set_title(f'$[{current_EER_index * 0.05:.2f}, {(current_EER_index + 1) * 0.05:.2f}]$')

[a.set_xlabel(xlabel_dict['curvature_bird_air_abs']) for a in ax[-1,:]]

fig, ax = plt.subplots(1,1, sharex='all', sharey='all', layout='constrained',
                       figsize=(figsize_multiplier * (4.75/4 + 0.4), figsize_multiplier *4.75/4 ))
ax_flat = ax
for i_eer, current_EER_index in enumerate(list_of_EER):
    ax_flat.plot(df_all_histograms_resampled_gt.loc[df_all_histograms_resampled_gt['EER_index'] == current_EER_index, 'bin_avg'],
                           df_all_histograms_resampled_gt.loc[df_all_histograms_resampled_gt['EER_index'] == current_EER_index, 'hist'],
                           alpha=1, c=matplotlib.colormaps['magma'](Normalize(0,1.1)(current_EER_index * 0.05)))
ax_flat.set_xlabel(xlabel_dict['curvature_bird_air_abs'])
simple_axis(ax_flat)
cbar = plt.colorbar(ScalarMappable(norm=Normalize(0,1.1), cmap=matplotlib.colormaps['magma']), ax=ax, label='EER')
cbar.ax.set_ylim((0,1))

fig.savefig(os.path.join(save_folder, 'png', 'template_histograms_overlap.png'))
fig.savefig(os.path.join(save_folder, 'svg', 'template_histograms_overlap.svg'))
# if save:
#     fig.savefig(os.path.join(save_folder, 'png', 'template_histograms.png'))
#     fig.savefig(os.path.join(save_folder, 'svg', 'template_histograms.svg'))