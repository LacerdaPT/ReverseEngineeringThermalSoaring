import os.path

import numpy as np
import pandas as pd
from matplotlib.colors import Normalize

from misc.config import science_matplotlib_config
from plotting.auxiliar import simple_axis

save=True
figsize_multiplier = 2

science_matplotlib_config(figsize_multiplier, save)
from matplotlib import pyplot as plt




xlabel_dict = {'curvature_bird_air_abs':     '$|\\kappa_\\mathrm{bird,air}| \\ (\\mathrm{m}^{-1})$',
                'curvature_bird_ground_abs': '$|\\kappa_\\mathrm{bird,ground}| \\ (\\mathrm{m}^{-1})$',
                'dKdT_bird_air_abs':         '$|d\\kappa/d t _\\mathrm{bird,air}| \\ (\\mathrm{m}^{-1}\\mathrm{s}^{-1})$',
                'dKdT_bird_ground_abs':      '$|d\\kappa/d t _\\mathrm{bird,ground}| \\ (\\mathrm{m}^{-1}\\mathrm{s}^{-1})$', }




df_best = pd.read_csv('synthetic_data/from_atlasz/newdata/storks/config/individual_bins/bin_z_size=10/n_resamples=1000/best_set_of_wing_loadings.csv', index_col=False)


base_path = 'results/behaviour/EER/histograms/storks/DEC'
save_folder = os.path.join(base_path, 'figures')
compared_against = 'GT'
df_concat                       = pd.read_csv(os.path.join(base_path, 'samples.csv'), index_col=False)
df_all_histograms               = pd.read_csv(os.path.join(base_path, 'hist_per_bird.csv'), index_col=False)
df_ks                           = pd.read_csv(os.path.join(base_path, 'metrics_best_scale_cut_01_GT.csv'), index_col=False)

df_all_histograms_resampled_gt  = pd.read_csv(f'results/behaviour/EER/histograms/templates_cut_01/{compared_against}/best_scale/hist_resampled.csv', index_col=False)

df_pearson = pd.read_csv(os.path.join(base_path, f'metrics_best_scale_cut_01_GT_pearson.csv'), index_col=False)
df_all_mins = pd.read_csv(os.path.join(base_path, f'metrics_best_scale_cut_01_GT_mins.csv'), index_col=False)
df_all_mins_with_WL = pd.read_csv(os.path.join(base_path, f'metrics_best_scale_cut_01_GT_mins_with_WL.csv'), index_col=False)

if save:
    os.makedirs(os.path.join(save_folder, 'png'), exist_ok=True)
    os.makedirs(os.path.join(save_folder, 'svg'), exist_ok=True)

list_of_columns = df_all_mins['col'].unique()

list_of_birds = df_concat['bird_name'].sort_values().unique()
list_of_EER = sorted(df_all_histograms_resampled_gt['EER_index'].unique())

my_bins = np.sort(np.unique(df_all_histograms_resampled_gt[['bin_min', 'bin_max']].values))

fig_corr, ax_corr = plt.subplots(1,1,  figsize=(figsize_multiplier * 2.4, figsize_multiplier * 1.6),
                                 layout='constrained')
my_norm = Normalize(df_best['WL_mode_avg'].min(), df_best['WL_mode_avg'].max())
df_all_mins_air = df_all_mins_with_WL[df_all_mins_with_WL['col'] == list_of_columns[0]]
ax_corr.scatter(df_all_mins_air.loc[df_all_mins_air['EER_index_chi2'] > 9, 'WL_mode_avg'],
                df_all_mins_air.loc[df_all_mins_air['EER_index_chi2'] > 9, 'EER_index_chi2'] * 0.05,
                c=df_all_mins_air.loc[df_all_mins_air['EER_index_chi2'] > 9, 'WL_mode_avg'],
                norm=my_norm, cmap='viridis_r')
ax_corr.set_xlabel('$ EER ^{\\ast}$')
ax_corr.set_ylabel('$W^L \\ \\ (\\mathrm{kg~m} ^{-2})$')
simple_axis(ax_corr)


if save:
    fig_corr.savefig(os.path.join(save_folder, 'png', 'EER_vs_wingloadings.png'))
    fig_corr.savefig(os.path.join(save_folder, 'svg', 'EER_vs_wingloadings.svg'))

prop_cycle = plt.rcParams['axes.prop_cycle']
colors = prop_cycle.by_key()['color']
list_of_birds = df_all_mins[df_all_mins['col'] == 'curvature_bird_air_abs'].sort_values('EER_index_chi2')['bird_name'].unique()
fig_curvature, ax_curvature = plt.subplots(6,4, sharex='all', figsize=(figsize_multiplier * 4.75, figsize_multiplier*5), layout='constrained')

ax = ax_curvature.flatten()
for i_bird, current_bird in enumerate(list_of_birds):
    current_df_bird = df_concat[df_concat['bird_name'] == current_bird]
    current_df_best = df_all_mins[df_all_mins['bird_name'] == current_bird]
    if current_df_best.empty:
        continue
    for i_col, col in enumerate(['curvature_bird_air_abs']):
        current_df_best_index, current_best_scale = current_df_best.loc[current_df_best['col'] == col, ['EER_index_chi2', 'scale_chi2']].values[0]
        current_best_bird_hist = df_all_histograms.loc[(df_all_histograms['bird_name'] == current_bird)
                                                       & (df_all_histograms['col'] == col), ['bin_avg','bin_min', 'hist']]
        current_best_eer_hist_gt = df_all_histograms_resampled_gt.loc[(df_all_histograms_resampled_gt['EER_index'] == current_df_best_index)
                                                                      & (df_all_histograms_resampled_gt['col'] == col)
                                                                      & (df_all_histograms_resampled_gt['scale'] == current_best_scale), ['bin_avg','bin_min', 'hist']]
        current_best_bird_hist = current_best_bird_hist[current_best_bird_hist['bin_min'] <= 0.1]
        current_best_eer_hist_gt = current_best_eer_hist_gt[current_best_eer_hist_gt['bin_min'] <= 0.1]
        ax[i_bird].bar(current_best_bird_hist['bin_avg'], current_best_bird_hist['hist'], width=0.008, align='center', alpha=0.5, fc='b', zorder=10)
        ax[i_bird].bar(current_best_eer_hist_gt['bin_avg'],
                              current_best_eer_hist_gt['hist'], width=0.008, align='center', alpha=0.5, fc='g') # , hatch='/'

        ax[i_bird].set_title(f'{current_df_best_index * 0.05:.2f}', fontsize=12)
[a.set_xlabel(xlabel_dict['curvature_bird_air_abs']) for a in ax_curvature[-1, :]]




if save:
    fig_curvature.savefig(os.path.join(save_folder, 'png', 'histograms_without_names.png'))
    fig_curvature.savefig(os.path.join(save_folder, 'svg', 'histograms_without_names.svg'))