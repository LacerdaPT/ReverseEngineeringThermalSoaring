import os.path
from pathlib import Path

import matplotlib.pyplot as plt
import numpy as np
import pandas as pd
from scipy.stats import PermutationMethod, pearsonr

from misc.config import science_matplotlib_config
from plotting.auxiliar import simple_axis

save=True
figsize_multiplier = 2

science_matplotlib_config(figsize_multiplier, save)

xlabel_dict = {'curvature_bird_air_abs':     '$|\\kappa_\\mathrm{bird,air}| \\ (\\mathrm{m}^{-1})$',
                'curvature_bird_ground_abs': '$|\\kappa_\\mathrm{bird,ground}| \\ (\\mathrm{m}^{-1})$',
                'dKdT_bird_air_abs':         '$|d\\kappa/d t _\\mathrm{bird,air}| \\ (\\mathrm{m}^{-1}\\mathrm{s}^{-1})$',
                'dKdT_bird_ground_abs':      '$|d\\kappa/d t _\\mathrm{bird,ground}| \\ (\\mathrm{m}^{-1}\\mathrm{s}^{-1})$', }


base_path = 'results/behaviour/EER/histograms/multiple_flock_behaviour_exploration/DEC'
save_folder = os.path.join(base_path, 'figures')
if save:
    os.makedirs(os.path.join(save_folder,'png'), exist_ok=True)
    os.makedirs(os.path.join(save_folder, 'svg'), exist_ok=True)

compared_against = 'GT'
df_concat                       = pd.read_csv(os.path.join(base_path, 'samples.csv'), index_col=False)
df_all_histograms               = pd.read_csv(os.path.join(base_path, 'hist_per_bird.csv'), index_col=False)
df_ks                           = pd.read_csv(os.path.join(base_path, 'metrics_cut_01_GT.csv'), index_col=False)

df_all_histograms_resampled_gt  = pd.read_csv(f'results/behaviour/EER/histograms/templates_cut_01/{compared_against}/hist_resampled.csv', index_col=False)

df_pearson = pd.read_csv(os.path.join(base_path, f'metrics_cut_01_GT_pearson.csv'), index_col=False)
df_all_mins = pd.read_csv(os.path.join(base_path, f'metrics_cut_01_GT_mins.csv'), index_col=False)

df_all_histograms_resampled_gt = df_all_histograms_resampled_gt[df_all_histograms_resampled_gt['scale'] == 1]

list_of_birds = df_ks[['bird_name', 'EER']].drop_duplicates().sort_values('EER').values[::5,0]
list_of_EER = sorted(df_all_histograms_resampled_gt['EER_index'].unique())
my_bins = np.sort(np.unique(df_all_histograms_resampled_gt[['bin_min', 'bin_max']].values))
########################################################################################################################
###############################################             BEST SCALE        ##########################################
########################################################################################################################
list_of_metrics = ['ks', 'chi2', 'relative_entropy_bird_eer',
                           'relative_entropy_eer_bird']
list_of_scales = np.sort(df_ks['scale'].unique())
list_of_columns = ['curvature_bird_air_abs']

# fig_violin, ax_violin = plt.subplots(2,4, sharey='col', sharex='all')
# for i_metric, m in enumerate(list_of_metrics):
#     for i_col, col in enumerate(list_of_columns):
#         current_df_col = df_ks[df_ks['col'] == col]
#         ax_violin[i_col,i_metric].violinplot([current_df_col.loc[round(current_df_col['scale'],1) == round(scale,1), m].values for i_scale, scale in enumerate(list_of_scales)],
#                                     list_of_scales, widths=0.05, showmeans=True
#                                 )
#         ax_violin[i_col,i_metric].set_ylabel(m)
#         ax_violin[i_col, i_metric].set_xlabel('scale')


df_all_mins_air = df_all_mins[df_all_mins['col'] == 'curvature_bird_air_abs']

fig_corr, ax_corr = plt.subplots(2,3,  sharex='row', sharey='all',
                                 layout='constrained', figsize=(figsize_multiplier * 4.75, figsize_multiplier * 3))
for i_idx, idx_col in enumerate( ['EER_index_ks', 'EER_index_chi2', 'EER_index_rel_entropy_bird_eer']):
    current_data = df_all_mins_air.loc[ df_all_mins_air[idx_col] > -1, ['actual_EER_index', idx_col]].values
    ax_corr[0, i_idx].scatter(current_data[:,0], current_data[:,1], alpha=0.2, s=figsize_multiplier * 10)
    ax_corr[0, i_idx].set_ylabel('$EER^{\\ast}_i$')
    ax_corr[0, i_idx].set_xlabel('$EER_i$')
    ax_corr[0, i_idx].plot([0,20],[0,20], 'k--')
    ax_corr[0, i_idx].set_aspect('equal')
    ax_corr[0, i_idx].set_title(idx_col.replace('EER_index_', ''))
    current_data = df_all_mins_air.loc[ df_all_mins_air[idx_col] > -1, ['EER', idx_col]].values
    ax_corr[1, i_idx].scatter(current_data[:,0] , current_data[:,1], alpha=0.2, s=figsize_multiplier * 10)
    ax_corr[1, i_idx].plot([0, 1], [0, 20], 'k--')
    ax_corr[1, i_idx].set_ylabel('$EER^{\\ast}$')
    ax_corr[1, i_idx].set_xlabel('$EER$')
    # ax_corr[1, i_idx].set_aspect('equal')
    simple_axis(ax_corr[0, i_idx])
    simple_axis(ax_corr[1, i_idx])

# ax_corr[i_idx].set_ylim(ax_corr[i_idx].get_xlim())

if save:
    fig_corr.savefig(os.path.join(save_folder, 'png', 'EER_index_correlations.png'))
    fig_corr.savefig(os.path.join(save_folder, 'svg', 'EER_index_correlations.svg'))

fig_curvature, ax_curvature = plt.subplots(5, 4, sharex='all', sharey='all',
                                           figsize=(figsize_multiplier * 4.75,figsize_multiplier*4.75 * 5 / 4), layout='constrained')

ax = [ax_curvature.flatten()]
for i_bird, current_bird in enumerate(list_of_birds):

    current_df_best = df_all_mins[df_all_mins['bird_name'] == current_bird]
    for i_col, col in enumerate(list_of_columns[:1]):
        (current_df_best_index,
         current_best_scale,
         current_actual_EER_index,
         current_actual_EER) = current_df_best.loc[current_df_best['col'] == col, ['EER_index_chi2',
                                                                                   'scale_chi2',
                                                                                   'actual_EER_index',
                                                                                   'EER']].values[0]
        current_best_bird_hist = df_all_histograms.loc[(df_all_histograms['bird_name'] == current_bird)
                                                       & (df_all_histograms['col'] == col), ['bin_avg','bin_min', 'hist']]
        current_best_eer_hist_gt = df_all_histograms_resampled_gt.loc[(df_all_histograms_resampled_gt['EER_index'] == current_df_best_index)
                                                                      & (df_all_histograms_resampled_gt['col'] == col), ['bin_avg','bin_min', 'hist']]
        current_best_bird_hist = current_best_bird_hist[current_best_bird_hist['bin_min'] <= 0.1]
        current_best_eer_hist_gt = current_best_eer_hist_gt[current_best_eer_hist_gt['bin_min'] <= 0.1]
        ax[i_col][i_bird].bar(current_best_bird_hist['bin_avg'], current_best_bird_hist['hist'],
                              width=0.008, align='center', alpha=0.5, fc='b', zorder=10)
        ax[i_col][i_bird].bar(current_best_eer_hist_gt['bin_avg'],
                              current_best_eer_hist_gt['hist'],
                              width=0.008, align='center', alpha=0.5, fc='g')
        ax[i_col][i_bird].set_title(f'${current_actual_EER:.2f}, {current_df_best_index * 0.05:.2f}$')


[a.set_xlabel(xlabel_dict['curvature_bird_air_abs']) for a in ax_curvature[-1, :]]

if save:
    fig_curvature.savefig(os.path.join(save_folder, 'png', 'histograms.png'))
    fig_curvature.savefig(os.path.join(save_folder, 'svg', 'histograms.svg'))