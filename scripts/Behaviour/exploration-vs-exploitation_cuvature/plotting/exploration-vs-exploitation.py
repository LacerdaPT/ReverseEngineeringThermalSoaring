import os.path
from pathlib import Path

import matplotlib
import matplotlib.pyplot as plt
import numpy as np
import pandas as pd
from matplotlib.cm import ScalarMappable
from matplotlib.colors import Normalize
from scipy import stats

from calc.auxiliar import get_smoothed_diff_per_partition
from data.get_data import load_synthetic_and_decomposed, load_synthetic_data, load_decomposition_data
from misc.config import science_matplotlib_config

save = False

figsize_multiplier = 2
science_matplotlib_config(figsize_multiplier, save=save)
path_to_gt_root = 'synthetic_data/from_atlasz/newdata/'
glob_string = 'EER_sweep_std/E*/*'
save_folder = 'results/behaviour/EER/figures'
if save:
    os.makedirs(os.path.join(save_folder, 'png'), exist_ok=True)
    os.makedirs(os.path.join(save_folder, 'svg'), exist_ok=True)
df_dict = {'dec':                      pd.read_csv(os.path.join('results/behaviour/EER/test', 'dKdT_binnned.csv'), index_col=False),
           'recalc_core':          pd.read_csv(os.path.join('results/behaviour/EER/test', 'dKdT_binnned_recalc_core.csv'), index_col=False),
           'recalc_K':             pd.read_csv(os.path.join('results/behaviour/EER/test', 'dKdT_binnned_recalc_K.csv'), index_col=False),
           'recalc_K_recalc_core': pd.read_csv(os.path.join('results/behaviour/EER/test', 'dKdT_binnned_recalc_K_recalc_core.csv'), index_col=False),
           'gt':                   pd.read_csv(os.path.join('results/behaviour/EER/test', 'dKdT_binnned_gt.csv'),index_col=False), }

p=Path(path_to_gt_root)
my_col = 'dKdT_abs'
min_occ = 10
my_colormap = matplotlib.colormaps['magma']
my_norm = Normalize(0,1.1)
fig, ax = plt.subplots(2,3, sharex='all', sharey='all', layout='constrained',figsize=(2*figsize_multiplier*1.7,figsize_multiplier*1.25))
ax = ax.flatten()
for i, (name, df) in enumerate(df_dict.items()):
    for current_bin_index in df['EER_bin_index'].unique():
        current_df_binned = df[df['EER_bin_index'] == current_bin_index]
        current_df_binned = current_df_binned[~current_df_binned[f'{my_col}_mean'].isna()]
        current_df_binned = current_df_binned[current_df_binned[f'{my_col}_count'] >= min_occ]
        current_df_binned.sort_values('rho_bird_TC_mean', inplace=True)
        ax[i].errorbar(current_df_binned['rho_bird_TC_mean'],
                    current_df_binned[f'{my_col}_mean'],
                    yerr= current_df_binned[f'{my_col}_sem'], c=my_colormap(my_norm(current_bin_index / 20)), alpha=0.7)
    ax[i].set_xlabel('$\\rho_{Glider,TC}$ (m)')
    ax[i].set_ylabel('$| d\\kappa /dT |$ (m$^{-1}$ s$^{-1}$)')
    ax[i].set_ylim((0, None))
    ax[i].set_title(name)

cbar = plt.colorbar(ScalarMappable(cmap=my_colormap, norm = my_norm),ax=ax[-1], label='EER')
cbar.ax.set_ylim((0,1))
if save:
    fig.savefig(os.path.join(save_folder, 'png', f'EER_spectrum.png'),transparent=True)
    fig.savefig(os.path.join(save_folder, 'svg', f'EER_spectrum.svg'))
