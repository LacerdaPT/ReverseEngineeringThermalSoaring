import os

import numpy as np
import pandas as pd
from matplotlib.cm import ScalarMappable
from matplotlib.colors import Normalize


from misc.config import science_matplotlib_config

from data.get_data import load_synthetic_data
from plotting.plot import plot_tracks_line, plot_tracks_line2d, line_plot2D


save = False

figsize_multiplier = 2

science_matplotlib_config(figsize_multiplier=figsize_multiplier, save=save)

import matplotlib
from matplotlib import pyplot as plt
plt.rc('axes', labelpad=figsize_multiplier*1)


root_path = '/home/pedro/PycharmProjects/ThermalModelling'


path_to_synthetic_data = os.path.join(root_path, 'synthetic_data/publication/EER_study/None')
save_folder = 'results/Figures/behaviour/trajectories'
if save:
    os.makedirs(os.path.join(save_folder, 'png'), exist_ok=True)
    os.makedirs(os.path.join(save_folder, 'svg'), exist_ok=True)
syn = load_synthetic_data(path_to_synthetic_data)
df_real = syn['data_real']
avf = syn['air_velocity_field']
df_birds = pd.DataFrame.from_records(syn['bird_parameters'])
my_list_of_birds = ['sb_00',  'sb_16', 'sb_20'] # 'sb_10', 'sb_13', 'sb_16',

my_angle = -np.arctan2(150,500)
# fig = plt.figure(figsize=(9,6), layout='tight')
# ax3d = fig.add_subplot(111, projection='3d')
# for i, my_bird in enumerate(my_list_of_birds):
#
#     current_bird = df_real[df_real['bird_name'] == my_bird]
#
#     # current_X = np.cos(my_angle) * (current_bird['X']) + np.sin(my_angle) * (current_bird['Y'])
#     # current_Y = -np.cos(my_angle) * (current_bird['X']) + np.cos(my_angle) * (current_bird['Y'])
#     current_X = current_bird['X'] - i * 50
#     current_Y = current_bird['Y']- i * 200
#
#     _, art = plot_tracks_line(ax3d,
#                               current_X ,
#                               current_Y ,
#                               current_bird['Z']+100,
#                               color_data=current_bird['time'],
#                               with_projection=True,
#                               projection_kwargs={'alpha': 0.25, 'linewidth': 1},
#                               zorder=10,
#                               alpha=1 ,
#                               #linewidth=1.5 * plt.rcParams['lines.linewidth'] if focus_bird == b else plt.rcParams['lines.linewidth']
#                               linewidth=1,
#                               )
# ax3d.view_init(azim=146, elev=30)
# ax3d.set_box_aspect((1.1,1.35,0.75))
#
# ax3d.xaxis.pane.set_color((1,1,1,1))
# ax3d.yaxis.pane.set_color((1,1,1,1))
# ax3d.zaxis.pane.set_color((1,1,1,1))
#
#
# ax3d.grid(False)
#
#
# ax3d.set_axis_off()
#
# fig.savefig(os.path.join(save_folder, 'png', f'EER_trajectories_3D.png'), transparent=True)
# fig.savefig(os.path.join(save_folder, 'svg', f'EER_trajectories_3D.svg'))


my_norm = Normalize(-1, 5.5)
z_value = 360
time_window = 50
X_window = Y_window = 40
grid_size = 1
fig, ax_arr2d = plt.subplots(1, 3, layout='tight', sharey='all', sharex='all', figsize=(figsize_multiplier * 3.5, figsize_multiplier * 3.5/ 3),
                                       width_ratios=[1,1,1.1])



ax_arr2d_flattened = ax_arr2d

my_bird_segments = pd.DataFrame()

for i, my_bird in enumerate(my_list_of_birds):

    current_bird = df_real[df_real['bird_name'] == my_bird]
    current_EER = df_birds.loc[df_birds['bird_name'] == my_bird, 'control_parameters'].values[0]['general_args']['exploration_exploitation_ratio']
    closest_index = (np.abs(current_bird['Z'] - z_value)).idxmin()
    center_point = current_bird.loc[closest_index]
    my_time = center_point['time']
    current_segment = current_bird[current_bird['time'].between(my_time-30, my_time)]
    my_bird_segments = pd.concat([my_bird_segments, current_segment])

if np.ptp(my_bird_segments['X_thermal_real']) > np.ptp(my_bird_segments['Y_thermal_real']):
    X_lim = Y_lim = [my_bird_segments['X_thermal_real'].min() - 1, my_bird_segments['X_thermal_real'].max() + 1 + grid_size]
else:
    X_lim = Y_lim = [my_bird_segments['Y_thermal_real'].min() - 1, my_bird_segments['Y_thermal_real'].max() + 1 + grid_size]
Z_section = z_value
mgs = np.meshgrid(np.arange(*X_lim, grid_size),
                  np.arange(*Y_lim, grid_size),
                  [z_value], #[current_segment['Z'].mean()]
)
xyz_mgs = np.stack(mgs, axis=-1)[...,0,:]

vz_mgs = avf.get_velocity(xyz_mgs, t = my_bird_segments['time'].mean(), relative_to_ground=False, include=['thermal', 'turbulence'])
for i, my_bird in enumerate(my_list_of_birds):
    current_segment = my_bird_segments[my_bird_segments['bird_name'] == my_bird]

    current_EER = df_birds.loc[df_birds['bird_name'] == my_bird, 'control_parameters'].values[0]['general_args']['exploration_exploitation_ratio']

    ax_arr2d_flattened[i].contourf(xyz_mgs[...,0], xyz_mgs[...,1], vz_mgs[...,2], levels=50, cmap='hot_r', norm=my_norm)
    plot_tracks_line2d(ax_arr2d_flattened[i], current_segment['X_thermal_real'], current_segment['Y_thermal_real'],
                       current_segment['time'].values, cmap=matplotlib.colormaps['viridis'], lw=plt.rcParams['lines.linewidth'] * 2,
                       capstyle='round', joinstyle='round')
    ax_arr2d_flattened[i].set_aspect('equal')
    ax_arr2d_flattened[i].set_xlabel('$X\' (\\mathrm{m})$')
    ax_arr2d_flattened[i].set_title(str(current_EER))
ax_arr2d[0].set_ylabel('$Y\' (\\mathrm{m})$')

fig.colorbar(ScalarMappable(norm=my_norm, cmap='hot_r'), ax=ax_arr2d[-1], label='$v_\\mathrm{Air,Z}~(\\mathrm{m~s}^{-1})$')

fig.colorbar(ScalarMappable(norm=Normalize(0,30), cmap='viridis'), ax=ax_arr2d[-2], label='$\\mathrm{Time}~(\\mathrm{s})$')


if save:
    fig.savefig(os.path.join(save_folder, 'png', f'EER_trajectories_2D.png'),transparent=True)
    fig.savefig(os.path.join(save_folder, 'svg', f'EER_trajectories_2D.svg'))



