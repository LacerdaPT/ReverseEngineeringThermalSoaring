import os.path
from pathlib import Path

import matplotlib
import matplotlib.pyplot as plt
import numpy as np
import pandas as pd
from matplotlib.colors import Normalize
from scipy import stats

from calc.auxiliar import get_smoothed_diff_per_partition, get_geometric_characteristics
from calc.geometry import get_curvature_from_trajectory
from data.get_data import load_synthetic_and_decomposed, load_synthetic_data, load_decomposition_data
from misc.constants import list_of_storks

path_to_gt_root = 'synthetic_data/from_atlasz/newdata/storks/'
glob_string = '*/decomposition/individual_bins/bin_z_size=10/optimized/n_resamples=1000/final/reconstructed'
df_delays = pd.read_csv('data_pedro/stork_individual_data.csv', index_col=False)

df_best = pd.read_csv('synthetic_data/from_atlasz/newdata/storks/config/individual_bins/bin_z_size=10/n_resamples=1000/best_set_of_wing_loadings.csv', index_col=False)

df_best = df_best.sort_values('WL_mode_avg')
df_delays.rename(columns={'Name':'bird_name'}, inplace=True)
list_of_bird = list_of_storks
parameter_dict_lambda = lambda p: {'realization': p.parents[4].name,
                                   'parameter_name': s.parents[0].name.split('=')[0],
                                   'parameter_value': float(s.parents[0].name.split('=')[1]),
                                   'sweep_type': s.parents[1].name}
df_pearson = []
p=Path(path_to_gt_root)
# ax_cv = ax[:,::2].flatten()
# ax_std = ax[:,1::2].flatten()
df_concat = pd.DataFrame()
group_1 = ['b010_0.1', 'b023_0.1', 'b023_1.1', 'b072_0.1']

for i_realization, s in enumerate(p.glob(glob_string)):
    path_to_decomposition = str(s)
    current_thermal = s.parents[6].name
    current_group = int(current_thermal in group_1)
    dec = load_decomposition_data(path_to_decomposition,list_of_files=['iterations.csv'])
    df = dec['iterations']


    df = df[df['in_hull'] & (~df['interpolated']) & (np.abs(df['curvature']) < 0.1)].copy()
    diff = get_smoothed_diff_per_partition(df, {
                                                f'dXdT_bird_ground': None,
                                                f'dYdT_bird_ground': None,
                                                f'dZdT_bird_ground': None} ,
                                           dt=1,
                                           method='5point',
                                           partition_key='bird_name')
    df['d2XdT2_bird_ground'] = diff['dXdT_bird_ground']
    df['d2YdT2_bird_ground'] = diff['dYdT_bird_ground']
    df['d2ZdT2_bird_ground'] = diff['dZdT_bird_ground']
    df_calc = get_geometric_characteristics(df,
        state_vector_columns = {'Vx': 'dXdT_bird_ground',
                                'Vy': 'dYdT_bird_ground',
                                'Ax': 'd2XdT2_bird_ground',
                                'Ay': 'd2YdT2_bird_ground'})
    df_calc = df_calc[['bird_name', 'time', 'curvature']]
    df_calc.rename(columns={'curvature': 'curvature_ground'}, inplace=True)
    df = pd.merge(df, df_calc, on=['bird_name', 'time'])
    diff = get_smoothed_diff_per_partition(df, {f'curvature_ground': None,
                                                f'curvature': None,} ,
                                           dt=1,
                                           method='5point',
                                           partition_key='bird_name')
    df['dKdT'] = diff['curvature']
    df['dKdT_ground'] = diff['curvature_ground']
    df['dKdT_abs'] = np.abs(df['dKdT'])
    df['dKdT_ground_abs'] = np.abs(df['dKdT_ground'])
    df['curvature_abs'] = np.abs(df['curvature'])
    df['curvature_ground_abs'] = np.abs(df['curvature_ground'])
    df['thermal'] = current_thermal
    df['group'] = current_group
    df_concat = pd.concat([df_concat, df])


# df_ma = df.sort_values('rho_bird_TC')[['rho_bird_TC', 'dKdT_abs']].rolling(400, min_periods=399, center=True).mean()
# plt.scatter(df['rho_bird_TC'], df['dKdT_abs'], alpha=0.05)
# plt.scatter(df_ma['rho_bird_TC'], df_ma['dKdT_abs'])
#
# df_n_neighbor = pd.merge(df_concat[['thermal', 'time', 'bird_name', 'dKdT_abs', 'Z']],
#                          df_concat[['thermal', 'time', 'bird_name', 'Z']], on=['thermal', 'time'])
# df_n_neighbor = df_n_neighbor[df_n_neighbor['bird_name_x'] != df_n_neighbor['bird_name_y']]
# df_n_neighbor = df_n_neighbor[df_n_neighbor['thermal'] == df_n_neighbor['thermal']]
# df_n_neighbor['delta_Z'] = df_n_neighbor['Z_y'] - df_n_neighbor['Z_x']
list_of_thermals = df_concat['thermal'].unique()
list_of_thermals = sorted(list_of_thermals)
# for t in list_of_thermals:
#     fig, ax = plt.subplots(4,3, sharex='all', layout='constrained')
#     ax = ax.flatten()
#     fig.suptitle(t)
#     for i_r, r_max in enumerate(np.arange(5,60,5)):
#
#         current_neighborhood = df_n_neighbor[(df_n_neighbor['delta_Z'].between(0, r_max)) & ( df_n_neighbor['thermal'] == t)]
#         current_neighborhood = current_neighborhood.sort_values(['bird_name_x', 'bird_name_y', 'time'])
#         current_neighborhood['delta_time'] = current_neighborhood['time'].diff()
#
#         current_neighborhood['flocking_change'] = current_neighborhood['delta_time'] > 2
#         current_neighborhood['flocking_change'] = current_neighborhood['flocking_change'].bfill()
#         current_neighborhood['flocking_event'] = ((~current_neighborhood['flocking_change']) & (current_neighborhood['flocking_change'].shift(1, fill_value=False))).cumsum()
#
#
#         current_neighborhood = current_neighborhood[~current_neighborhood['flocking_change']]
#         event_duration = current_neighborhood[['thermal', 'bird_name_x', 'bird_name_y', 'flocking_event', 'time'
#                                                ]].groupby(['thermal', 'bird_name_x', 'bird_name_y','flocking_event'
#                                                            ]).agg(tmax = ('time', 'max'), tmin= ('time', 'min')).reset_index()
#         event_duration['duration'] = event_duration['tmax'] - event_duration['tmin']
#         event_duration = event_duration[event_duration['duration'] >=15]
#
#         current_neighborhood = pd.merge(current_neighborhood, event_duration[event_duration['duration'] >= 15],
#                                         on=['thermal', 'bird_name_x', 'bird_name_y', 'flocking_event'])
#         bbb = current_neighborhood.groupby(['thermal', 'time', 'bird_name_x', 'dKdT_abs']).agg(n=('bird_name_y', 'count')).reset_index()
#         bbb_mean = bbb[['dKdT_abs', 'n']].groupby('n').mean().reset_index()
#         # ax[i_r].scatter(bbb['n'], bbb['dKdT_abs'], alpha=0.05)
#         ax[i_r].scatter(bbb_mean['n'], bbb_mean['dKdT_abs'])
#         ax[i_r].set_title(r_max)
#         ax[i_r].set_xlabel('# neighbors')
#         ax[i_r].set_ylabel('dKdT_abs')
#
#
#
#
#
#
# aaa = pd.merge_asof(df_concat.sort_values('Z'), df_concat.sort_values('Z'),on='Z', by=['time', 'thermal'], allow_exact_matches=False, direction='nearest')
#
# df_closest = pd.merge(aaa, df, left_on=['thermal', 'time', 'bird_name_y'], right_on=['thermal', 'time', 'bird_name'])
#
#
# df_closest['delta_Z'] = df_closest['Z_x'] - df_closest['Z_y']
#
#
# df_ma = df_closest.sort_values('delta_Z')[['delta_Z', 'dKdT_abs']].rolling(400, min_periods=399, center=True).mean()
#
# plt.scatter( df_closest['delta_Z'],  df_closest['dKdT_abs'], alpha=0.05)
# plt.scatter(df_ma['delta_Z'], df_ma['dKdT_abs'])
#
#
# df_z_max = df_concat[['thermal','time', 'Z']].groupby(['thermal','time']).max()
# df_z_max.rename(columns={'Z': 'Z_max'}, inplace=True)
# df_rank = pd.merge(df_concat, df_z_max, on=['thermal','time'])
# df_rank['delta_Z'] = df_rank['Z_max'] - df_rank['Z']
#
# df_ma = df_rank[df_rank['delta_Z'] > 0 ].sort_values('delta_Z')[['delta_Z', 'dKdT_abs']].rolling(400, min_periods=399, center=True).mean()
#
# plt.scatter( df_rank[df_rank['delta_Z'] > 0 ]['delta_Z'],  df_rank[df_rank['delta_Z'] > 0 ]['dKdT_abs'], alpha=0.05)
# plt.scatter(df_ma['delta_Z'], df_ma['dKdT_abs'])
#
#
# df_stats_per_group_per_bird = df_concat[['group', 'bird_name', 'dKdT_abs',
#                'curvature_abs',
#                'curvature',
#                'dKdT_ground_abs',
#                'curvature_ground_abs',
#                'curvature_ground'
#                                          ]].groupby(['group', 'bird_name']).agg(dKdT_abs_avg = ('dKdT_abs','mean'),
#                                                       dKdT_abs_median = ('dKdT_abs','median'),
#                                                       dKdT_abs_std = ('dKdT_abs','std'),
#                                                       dKdT_abs_count = ('dKdT_abs','count'),
#                                                       dKdT_abs_sem = ('dKdT_abs','sem'),
#                                                       curvature_avg=('curvature', 'mean'),
#                                                       curvature_median=('curvature', 'median'),
#                                                       curvature_std=('curvature', 'std'),
#                                                       curvature_count=('curvature', 'count'),
#                                                       curvature_sem=('curvature', 'sem'),
#                                                       curvature_abs_avg=('curvature_abs', 'mean'),
#                                                       curvature_abs_median=('curvature_abs', 'median'),
#                                                       curvature_abs_std=('curvature_abs', 'std'),
#                                                       curvature_abs_count=('curvature_abs', 'count'),
#                                                       curvature_abs_sem=('curvature_abs', 'sem'),
#                                                       dKdT_ground_abs_avg=('dKdT_ground_abs', 'mean'),
#                                                       dKdT_ground_abs_median=('dKdT_ground_abs', 'median'),
#                                                       dKdT_ground_abs_std=('dKdT_ground_abs', 'std'),
#                                                       dKdT_ground_abs_count=('dKdT_ground_abs', 'count'),
#                                                       dKdT_ground_abs_sem=('dKdT_ground_abs', 'sem'),
#                                                       curvature_ground_avg=('curvature_ground', 'mean'),
#                                                       curvature_ground_median=('curvature_ground', 'median'),
#                                                       curvature_ground_std=('curvature_ground', 'std'),
#                                                       curvature_ground_count=('curvature_ground', 'count'),
#                                                       curvature_ground_sem=('curvature_ground', 'sem'),
#                                                       curvature_ground_abs_avg=('curvature_ground_abs', 'mean'),
#                                                       curvature_ground_abs_median=('curvature_ground_abs', 'median'),
#                                                       curvature_ground_abs_std=('curvature_ground_abs', 'std'),
#                                                       curvature_ground_abs_count=('curvature_ground_abs', 'count'),
#                                                       curvature_ground_abs_sem=('curvature_ground_abs', 'sem')
#                                                       ).reset_index()
#
# df_stats_per_bird = df_concat[['group', 'bird_name', 'dKdT_abs',
#                'curvature_abs',
#                'curvature',
#                'dKdT_ground_abs',
#                'curvature_ground_abs',
#                'curvature_ground'
#                                          ]].groupby(['bird_name']).agg(dKdT_abs_avg = ('dKdT_abs','mean'),
#                                                       dKdT_abs_median = ('dKdT_abs','median'),
#                                                       dKdT_abs_std = ('dKdT_abs','std'),
#                                                       dKdT_abs_count = ('dKdT_abs','count'),
#                                                       dKdT_abs_sem = ('dKdT_abs','sem'),
#                                                       curvature_avg=('curvature', 'mean'),
#                                                       curvature_median=('curvature', 'median'),
#                                                       curvature_std=('curvature', 'std'),
#                                                       curvature_count=('curvature', 'count'),
#                                                       curvature_sem=('curvature', 'sem'),
#                                                       curvature_abs_avg=('curvature_abs', 'mean'),
#                                                       curvature_abs_median=('curvature_abs', 'median'),
#                                                       curvature_abs_std=('curvature_abs', 'std'),
#                                                       curvature_abs_count=('curvature_abs', 'count'),
#                                                       curvature_abs_sem=('curvature_abs', 'sem'),
#                                                       dKdT_ground_abs_avg=('dKdT_ground_abs', 'mean'),
#                                                       dKdT_ground_abs_median=('dKdT_ground_abs', 'median'),
#                                                       dKdT_ground_abs_std=('dKdT_ground_abs', 'std'),
#                                                       dKdT_ground_abs_count=('dKdT_ground_abs', 'count'),
#                                                       dKdT_ground_abs_sem=('dKdT_ground_abs', 'sem'),
#                                                       curvature_ground_avg=('curvature_ground', 'mean'),
#                                                       curvature_ground_median=('curvature_ground', 'median'),
#                                                       curvature_ground_std=('curvature_ground', 'std'),
#                                                       curvature_ground_count=('curvature_ground', 'count'),
#                                                       curvature_ground_sem=('curvature_ground', 'sem'),
#                                                       curvature_ground_abs_avg=('curvature_ground_abs', 'mean'),
#                                                       curvature_ground_abs_median=('curvature_ground_abs', 'median'),
#                                                       curvature_ground_abs_std=('curvature_ground_abs', 'std'),
#                                                       curvature_ground_abs_count=('curvature_ground_abs', 'count'),
#                                                       curvature_ground_abs_sem=('curvature_ground_abs', 'sem')
#                                                       ).reset_index()
#
#
#
#
# df_stats_per_bird['curvature_abs_CV'] = df_stats_per_bird['curvature_abs_std'] / df_stats_per_bird['curvature_abs_avg']
# df_stats_per_bird['curvature_CV'] = df_stats_per_bird['curvature_std'] / np.abs(df_stats_per_bird['curvature_avg'])
# df_stats_per_bird['curvature_ground_abs_CV'] = df_stats_per_bird['curvature_ground_abs_std'] / df_stats_per_bird['curvature_ground_abs_avg']
# df_stats_per_bird['curvature_ground_CV'] = df_stats_per_bird['curvature_ground_std'] / np.abs(df_stats_per_bird['curvature_ground_avg'])
#
# df_stats_per_group_per_bird['curvature_abs_CV'] = df_stats_per_group_per_bird['curvature_abs_std'] / df_stats_per_group_per_bird['curvature_abs_avg']
# df_stats_per_group_per_bird['curvature_CV'] = df_stats_per_group_per_bird['curvature_std'] / np.abs(df_stats_per_group_per_bird['curvature_avg'])
# df_stats_per_group_per_bird['curvature_ground_abs_CV'] = df_stats_per_group_per_bird['curvature_ground_abs_std'] / df_stats_per_group_per_bird['curvature_ground_abs_avg']
# df_stats_per_group_per_bird['curvature_ground_CV'] = df_stats_per_group_per_bird['curvature_ground_std'] / np.abs(df_stats_per_group_per_bird['curvature_ground_avg'])
# current_dict = {}
# # for metric_col in ['dKdT_abs_avg', 'curvature_abs_std', 'curvature_std', 'curvature_abs_CV']:
# #
# #     current_dict[f'{metric_col}_r'], current_dict[f'{metric_col}_p'] = stats.pearsonr(df_merge['EER'], df_merge[f'{metric_col}'],method=stats.PermutationMethod(1000, batch=1000))
# #
#
# # current_dict.update(parameter_dict_lambda(s))
# # df_pearson.append(current_dict)
#
# df_stats_per_group_per_bird = df_stats_per_group_per_bird.sort_values('bird_name')
# df_stats_per_bird = df_stats_per_bird.sort_values('bird_name')
#
# df_merge_per_group_per_bird = pd.merge(df_stats_per_group_per_bird, df_delays, on='bird_name', how='inner')
# df_merge_per_bird = pd.merge(df_stats_per_bird, df_delays, on='bird_name', how='inner')
#
#
#
# fig,ax = plt.subplots(3,2, layout='constrained', sharey='col', sharex='all')
#
# ax_group = ax[1:]
# ax = ax[0]
#
# for i_metric, metric_col in enumerate(['dKdT_abs', 'dKdT_ground_abs']):
#     for group in range(2):
#         df_group = df_merge_per_group_per_bird[df_merge_per_group_per_bird['group'] == group]
#         ax_group[group, i_metric].errorbar(df_group['bird_name'].apply(lambda x: list_of_bird.index(x)), df_group[f'{metric_col}_avg'], df_group[f'{metric_col}_sem'], fmt='o')
#         ax_group[group, i_metric].set_xticks(df_group['bird_name'].apply(lambda x: list_of_bird.index(x)), labels=df_group['bird_name'].unique(), rotation=90)
#         ax_group[group, i_metric].set_ylabel(f'group {group}')
#
#     ax[i_metric].errorbar(df_merge_per_bird['bird_name'].apply(lambda x: list_of_bird.index(x)), df_merge_per_bird[f'{metric_col}_avg'], df_merge_per_bird[f'{metric_col}_sem'], fmt='o')
#     ax[i_metric].set_xticks(df_merge_per_bird['bird_name'].apply(lambda x: list_of_bird.index(x)), labels=df_merge_per_bird['bird_name'].unique(), rotation=90)
#     ax[i_metric].set_ylabel(f'both')
#     ax[i_metric].set_title(metric_col)
#
# fig_corr,ax_metrics = plt.subplots(4,3, layout='constrained',)
# ax_corr = ax_metrics[:,:2]
# ax_compare = ax_metrics[:,2]
# ax_both = ax_corr[0]
# ax_cc = ax_corr[3]
# ax_corr = ax_corr[1:3]
# ax_corr[0,0].sharey(ax_corr[1,0])
# ax_corr[0,1].sharey(ax_corr[1,1])
#
#
# for i_metric, metric_col in enumerate(['dKdT_abs', 'dKdT_ground_abs']):
#     for group in range(2):
#         df_group = df_merge_per_group_per_bird[df_merge_per_group_per_bird['group'] == group]
#         ax_corr[group, i_metric].errorbar(df_group['AvrTM(s)'], df_group[f'{metric_col}_avg'], df_group[f'{metric_col}_sem'], fmt='o')
#     ax_both[i_metric].errorbar(df_merge_per_bird['AvrTM(s)'], df_merge_per_bird[f'{metric_col}_avg'],  df_merge_per_bird[f'{metric_col}_sem'], fmt='o',#mfc=matplotlib.colormaps['viridis'](Normalize(df_merge_per_bird['FA']))
#                                )
#
# for i_metric,metric_col in enumerate( ['dKdT_abs', 'dKdT_ground_abs']):
#     df_inner = pd.merge(df_merge_per_group_per_bird[df_merge_per_group_per_bird['group'] == 0],
#                         df_merge_per_group_per_bird[df_merge_per_group_per_bird['group'] == 1], on='bird_name', how='inner')
#     ax_cc[i_metric].errorbar(df_inner[f'{metric_col}_avg_x'], df_inner[f'{metric_col}_avg_y'],df_inner[f'{metric_col}_sem_x'], df_inner[f'{metric_col}_sem_y'], fmt='o')
#
# for i_metric, metric_col in enumerate(['dKdT_abs', 'dKdT_ground_abs',]):
#     ax_corr[0, i_metric].set_title(metric_col)
#     ax_corr[-1, i_metric].set_xlabel('AvrTM(s)')
#     ax_cc[i_metric].set_xlabel('group 0')
#     ax_cc[i_metric].set_ylabel('group 1')
#
#
# for group in range(2):
#     df_group = df_merge_per_group_per_bird[df_merge_per_group_per_bird['group'] == group]
#     ax_compare[group + 1].errorbar(df_group[f'dKdT_abs_avg'], df_group[f'dKdT_ground_abs_avg'], df_group[f'dKdT_abs_sem'],
#                                    xerr=df_group[f'dKdT_ground_abs_sem'], fmt='o')
#     ax_compare[group + 1].set_xlabel('dKdT_abs_avg')
#     ax_compare[group + 1].set_ylabel('dKdT_ground_abs_avg')
# ax_compare[0].errorbar(df_merge_per_bird[f'dKdT_abs_avg'], df_merge_per_bird[f'dKdT_ground_abs_avg'], df_merge_per_bird[f'dKdT_abs_sem'],
#                                    xerr=df_merge_per_bird[f'dKdT_ground_abs_sem'], fmt='o')
# ax_compare[0].set_xlabel('dKdT_abs_avg')
# ax_compare[0].set_ylabel('dKdT_ground_abs_avg')
#
#
#
# ax_cc[0].set_aspect('equal',adjustable='datalim')
# ax_cc[1].set_aspect('equal',adjustable='datalim')
# # ax_cv[i_realization].scatter(df_merge['EER'], df_merge['curvature_abs_CV'], )
# # ax_std[i_realization].scatter(df_merge['EER'], df_merge['curvature_CV'],)
# # # ax[0].set_xlabel('EER')
# # # ax[0].set_ylabel('dKdT_abs_avg')
# # ax_cv[i_realization].set_xlabel('EER')
# # ax_cv[i_realization].set_ylabel('curvature_abs_CV')
# # ax_std[i_realization].set_xlabel('EER')
# # ax_std[i_realization].set_ylabel('curvature_CV')
# plt.show(block=True)


my_col = 'dKdT_abs'
fig, ax = plt.subplots(1,3, sharex='all', sharey='all', layout='constrained')

window_size = 15*3*23
for group in range(2):
    df_current_bird = df_concat[(df_concat['group'] == group)]
    df_current_bird = df_current_bird[~df_current_bird[my_col].isna()]
    df_ma = df_current_bird.sort_values('rho_bird_TC')[['rho_bird_TC', my_col]].rolling(window_size, min_periods=window_size-1, center=True).mean()
    df_current_bird = df_current_bird[df_current_bird['rho_bird_TC'].between(0,50)]
    # ax[group].scatter(df_current_bird['rho_bird_TC'], df_current_bird[my_col],alpha=0.02)
    ax[group].plot(df_ma.loc[df_ma['rho_bird_TC'].between(0,50),'rho_bird_TC'],
                    df_ma.loc[df_ma['rho_bird_TC'].between(0,50), my_col],'r',)
    ax[group].set_title(f'{group=}')
df_current_bird = df_concat.copy()  #[(df_concat['group'] == group)]
window_size= 15*7*23
df_current_bird = df_current_bird[~df_current_bird[my_col].isna()]
df_ma = df_current_bird.sort_values('rho_bird_TC')[['rho_bird_TC', my_col]].rolling(window_size, min_periods=window_size-1, center=True).mean()
df_current_bird = df_current_bird[df_current_bird['rho_bird_TC'].between(0,50)]
# ax[-1].scatter(df_current_bird['rho_bird_TC'], df_current_bird[my_col],alpha=0.02)
ax[-1].plot(df_ma.loc[df_ma['rho_bird_TC'].between(0,50),'rho_bird_TC'],
                df_ma.loc[df_ma['rho_bird_TC'].between(0,50), my_col],'r')
ax[-1].set_title(f'both')

ax[-1].set_ylim((0,0.02))



window_size=15*23
window_size_group = 15*3*23
my_col = 'dKdT_abs'
fig, ax = plt.subplots(2,5, sharex='all', sharey='all', layout='constrained')
ax = ax.flatten()
for i_thermal, t in enumerate(list_of_thermals):
    df_current_bird = df_concat[(df_concat['thermal'] == t)]
    df_current_bird = df_current_bird[~df_current_bird[my_col].isna()]
    df_ma = df_current_bird.sort_values('rho_bird_TC')[['rho_bird_TC', my_col]].rolling(window_size, min_periods=window_size-1, center=True).mean()
    df_current_bird = df_current_bird[df_current_bird['rho_bird_TC'].between(10,50)]
    # ax[i_thermal].scatter(df_current_bird['rho_bird_TC'], df_current_bird[my_col],alpha=0.02)
    ax[i_thermal].plot(df_ma.loc[df_ma['rho_bird_TC'].between(10,50),'rho_bird_TC'],
                    df_ma.loc[df_ma['rho_bird_TC'].between(10,50), my_col],)
    ax[i_thermal].set_title(t)

    ### GROUP
    current_group = int(t in group_1)
    df_current_bird_group = df_concat[(df_concat['group'] == group)]
    df_current_bird_group = df_current_bird_group[~df_current_bird_group[my_col].isna()]
    df_ma_group = df_current_bird_group.sort_values('rho_bird_TC')[['rho_bird_TC', my_col]].rolling(window_size_group, min_periods=window_size_group-1, center=True).mean()
    df_current_bird_group = df_current_bird_group[df_current_bird_group['rho_bird_TC'].between(0,50)]
    # ax[group].scatter(df_current_bird['rho_bird_TC'], df_current_bird[my_col],alpha=0.02)
    ax[i_thermal].plot(df_ma_group.loc[df_ma_group['rho_bird_TC'].between(0,50),'rho_bird_TC'],
                    df_ma_group.loc[df_ma_group['rho_bird_TC'].between(0,50), my_col],f'C{current_group + 1}')

ax[i_thermal].set_ylim((0,0.02))

window_size= 15*7*23
df_current_bird = df_current_bird[~df_current_bird[my_col].isna()]
df_ma = df_current_bird.sort_values('rho_bird_TC')[['rho_bird_TC', my_col]].rolling(window_size, min_periods=window_size-1, center=True).mean()
df_current_bird = df_current_bird[df_current_bird['rho_bird_TC'].between(0,50)]
# ax[-1].scatter(df_current_bird['rho_bird_TC'], df_current_bird[my_col],alpha=0.02)
ax[-1].plot(df_ma.loc[df_ma['rho_bird_TC'].between(0,50),'rho_bird_TC'],
                df_ma.loc[df_ma['rho_bird_TC'].between(0,50), my_col],f'C{current_group + 2}')
ax[-1].set_title(f'both')

ax[-1].set_ylim((0,0.02))

window_size=15*3

my_col = 'dKdT_abs'
fig, ax = plt.subplots(5,5, sharex='all', sharey='all', layout='constrained')
ax = ax.flatten()
for group in range(2):
    for i_bird, bird in enumerate(df_best['bird_name'].values):
        df_current_bird = df_concat[(df_concat['bird_name'] == bird) & (df_concat['group'] == group)]
        df_current_bird = df_current_bird[~df_current_bird[my_col].isna()]
        df_ma = df_current_bird.sort_values('rho_bird_TC')[['rho_bird_TC', my_col]].rolling(window_size, min_periods=window_size-1, center=True).mean()
        df_current_bird = df_current_bird[df_current_bird['rho_bird_TC'].between(10,50)]
        # ax[i_bird].scatter(df_current_bird['rho_bird_TC'], df_current_bird[my_col],alpha=0.02)
        ax[i_bird].plot(df_ma.loc[df_ma['rho_bird_TC'].between(10,50),'rho_bird_TC'],
                        df_ma.loc[df_ma['rho_bird_TC'].between(10,50), my_col],c=f'C{group}', label=group)
        ax[i_bird].set_title(bird)
ax[i_bird].legend()
ax[i_bird].set_ylim((0,0.02))

# ax[i_thermal].legend()
df_pearson=pd.DataFrame(df_pearson,)