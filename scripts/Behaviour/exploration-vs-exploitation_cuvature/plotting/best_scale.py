import os.path
from pathlib import Path

import matplotlib.pyplot as plt
import numpy as np
import pandas as pd
from scipy.stats import pearsonr, PermutationMethod



save=False
path_to_gt_root = 'synthetic_data/from_atlasz/newdata/storks'
glob_string = 'b*'
save_folder = 'results/behaviour/EER/test'
save_filename = 'dKdT_binnned_recalc_core.csv'
if save:
    os.makedirs(save_folder, exist_ok=True)
parameter_dict_lambda = lambda p: {'realization': p.parents[4].name,
                                   'parameter_name': p.parents[0].name.split('=')[0],
                                   'parameter_value': float(p.parents[0].name.split('=')[1]),
                                   'sweep_type': p.parents[1].name}

df_delays = pd.read_csv('data_pedro/stork_individual_data.csv', index_col=False)
df_delays.rename(columns={'Name':'bird_name'}, inplace=True)
list_bird_TM_sorted = df_delays['AvrTM(s)']

df_concat_gt = pd.read_csv('results/behaviour/EER/histograms/eer_sweep_samples.csv', index_col=False)

df_concat_gt.rename(columns={'EER_bin_index':'EER_index'}, inplace=True)

df_best = pd.read_csv('synthetic_data/from_atlasz/newdata/storks/config/individual_bins/bin_z_size=10/n_resamples=1000/best_set_of_wing_loadings.csv', index_col=False)



df_binned_concat  = pd.DataFrame()
bin_size = 2
p=Path(path_to_gt_root)


rho_col = 'rho_bird_TC'
list_of_thermals = ['b010_0.1', 'b023_0.1',  'b072_0.1', 'b077_0.1', 'b112_0.2', 'b121_0.1']
df_concat = pd.read_csv('results/behaviour/EER/histograms/storks_concat.csv', index_col=False)

xlabel_dict = {'curvature_bird_air_abs':     '$|\\kappa_\\mathrm{bird,air}|$',
                'curvature_bird_ground_abs': '$|\\kappa_\\mathrm{bird,ground}|$' }


list_of_birds = df_concat['bird_name'].sort_values().unique()
list_of_EER = sorted(df_concat_gt['EER_index'].unique())


my_bins = np.linspace(0, 0.2, round(np.sqrt(df_concat['curvature_bird_air_abs'].size / len(list_of_birds))))

df_ks = pd.read_csv('results/behaviour/EER/histograms/best_scale/ks.csv', index_col=False)
df_all_histograms_resampled_gt = pd.read_csv('results/behaviour/EER/histograms/best_scale/hist_gt_resampled.csv', index_col=False)
df_all_histograms = pd.read_csv('results/behaviour/EER/histograms/best_scale/histograms_storks.csv', index_col=False)
df_ks.rename(columns={'statistic': 'ks', 'pvalue': 'ks_pvalue', 'statistic_location': 'ks_location', 'statistic_sign': 'ks_sign'}, inplace=True)
list_of_columns = df_ks['col'].unique()

dict_of_df_min = {}
df_ks_min = pd.merge(df_ks,
                     df_ks[['bird_name', 'col','ks']].groupby(['bird_name', 'col']).agg(
                         best_index=('ks', 'idxmin')).reset_index().drop(columns=['bird_name', 'col']),
         left_index=True, right_on='best_index')


df_chi2_min = pd.merge(df_ks,
                     df_ks[['bird_name', 'col','chi2']].groupby(['bird_name', 'col']).agg(
                         best_index=('chi2', 'idxmin')).reset_index().drop(columns=['bird_name', 'col']),
         left_index=True, right_on='best_index')
df_rel_entropy_bird_eer_min = pd.merge(df_ks,
                     df_ks[['bird_name', 'col','relative_entropy_bird_eer']].groupby(['bird_name', 'col']).agg(
                         best_index=('relative_entropy_bird_eer', 'idxmin')).reset_index().drop(columns=['bird_name', 'col']),
         left_index=True, right_on='best_index')
df_rel_entropy_eer_bird_min = pd.merge(df_ks,
                     df_ks[['bird_name', 'col','relative_entropy_eer_bird']].groupby(['bird_name', 'col']).agg(
                         best_index=('relative_entropy_eer_bird', 'idxmin')).reset_index().drop(columns=['bird_name', 'col']),
         left_index=True, right_on='best_index')

df_ks_min.rename(columns={'EER_index': 'EER_index_ks'}, inplace=True)
df_chi2_min.rename(columns={'EER_index': 'EER_index_chi2'}, inplace=True)
df_rel_entropy_bird_eer_min.rename(columns={'EER_index': 'EER_index_rel_entropy_bird_eer'}, inplace=True)
df_rel_entropy_eer_bird_min.rename(columns={'EER_index': 'EER_index_rel_entropy_eer_bird'}, inplace=True)
df_ks_min.rename(columns={'scale': 'scale_ks'}, inplace=True)
df_chi2_min.rename(columns={'scale': 'scale_chi2'}, inplace=True)
df_rel_entropy_bird_eer_min.rename(columns={'scale': 'scale_rel_entropy_bird_eer'}, inplace=True)
df_rel_entropy_eer_bird_min.rename(columns={'scale': 'scale_rel_entropy_eer_bird'}, inplace=True)

common_cols = ['bird_name', 'col']
df_all_mins = pd.merge(df_ks_min[common_cols + ['EER_index_ks', 'scale_ks', 'ks', 'ks_pvalue', 'ks_location', 'ks_sign']],
                       df_chi2_min[common_cols + ['EER_index_chi2', 'scale_chi2','chi2']], on=common_cols)

df_all_mins = pd.merge(df_all_mins,
                       df_rel_entropy_bird_eer_min[common_cols + ['EER_index_rel_entropy_bird_eer', 'scale_rel_entropy_bird_eer', 'relative_entropy_bird_eer']], on=common_cols)
df_all_mins = pd.merge(df_all_mins,
                       df_rel_entropy_eer_bird_min[common_cols + ['EER_index_rel_entropy_eer_bird', 'scale_rel_entropy_eer_bird', 'relative_entropy_eer_bird']], on=common_cols)

df_index_corr = df_all_mins[['EER_index_ks', 'EER_index_chi2', 'EER_index_rel_entropy_bird_eer', 'EER_index_rel_entropy_eer_bird',]].corr()
df_index_corr_air = df_all_mins.loc[(df_all_mins['col'] == list_of_columns[0])
                                    & (df_all_mins['EER_index_ks'] > 9
                                       ),['EER_index_ks',
                                          'EER_index_chi2',
                                          'EER_index_rel_entropy_bird_eer', 'EER_index_rel_entropy_eer_bird',]].corr()

df_all_mins = pd.merge(df_all_mins,df_delays[['bird_name', 'AvrTM(s)']], on='bird_name')
df_all_mins = pd.merge(df_all_mins,df_best[['bird_name', 'WL_mode_avg']], on='bird_name')


fig_corr, ax_corr = plt.subplots(1,2,  sharex='all')
df_all_mins_air = df_all_mins[df_all_mins['col'] == list_of_columns[0]]
for i_col, col  in enumerate( ['AvrTM(s)', 'WL_mode_avg']):
    ax_corr[i_col].scatter(df_all_mins_air['EER_index_chi2'], df_all_mins_air[col])

list_of_pearson = []
for i_idx, idx_col in enumerate( ['EER_index_ks','EER_index_chi2', 'EER_index_rel_entropy_bird_eer']):
    for i_col, col  in enumerate( ['AvrTM(s)', 'WL_mode_avg']):
        current_data = df_all_mins_air.loc[ df_all_mins_air[idx_col] > 9, [idx_col,col]].values
        p_result = pearsonr(current_data[:,0], current_data[:,1], method=PermutationMethod(1000,1000))
        list_of_pearson.append([idx_col, col, p_result.statistic, p_result.pvalue, current_data.shape[0], ])

df_pearson = pd.DataFrame(list_of_pearson, columns=['EER_index_col', 'col', 'pearsonr', 'pvalue', 'n'])


fig_curvature, ax_curvature = plt.subplots(4, 6 * 2, sharex='all', figsize=(18,9), layout='constrained')

ax = [ax_curvature[:2].flatten(),
      ax_curvature[2:].flatten(),]
for i_bird, current_bird in enumerate(list_of_birds):
    current_df_bird = df_concat[df_concat['bird_name'] == current_bird]
    current_df_best = df_all_mins[df_all_mins['bird_name'] == current_bird]
    for i_col, col in enumerate(list_of_columns):
        current_df_best_index, current_best_scale = current_df_best.loc[current_df_best['col'] == col, ['EER_index_chi2', 'scale_chi2']].values[0]
        current_best_bird_hist = df_all_histograms.loc[(df_all_histograms['bird_name'] == current_bird)
                                                       & (df_all_histograms['col'] == col), ['bin_avg', 'hist']]
        current_best_eer_hist_gt = df_all_histograms_resampled_gt.loc[(df_all_histograms_resampled_gt['EER_index'] == current_df_best_index)
                                                                      & (df_all_histograms_resampled_gt['col'] == col)
                                                                      & (df_all_histograms_resampled_gt['scale'] == current_best_scale), ['bin_avg', 'hist']]
        ax[i_col][i_bird].bar(current_best_bird_hist['bin_avg'], current_best_bird_hist['hist'], width=0.008, align='center', alpha=0.5, fc='b')
        ax[i_col][i_bird].bar(current_best_eer_hist_gt['bin_avg'],
                              current_best_eer_hist_gt['hist'], width=0.008, align='center', alpha=0.5, fc='g')

        ax[i_col][i_bird].set_xlabel(xlabel_dict[col])
        ax[i_col][i_bird].set_title(current_bird + '\n' + f'{current_df_best_index:.0f}'+ f' {current_best_scale:1g}')





fig, ax = plt.subplots(4, 6, sharex='row', figsize=(18,9), layout='constrained')
fig.suptitle('WL')
ax[0,0].sharex(ax[1,0])
ax[2,0].sharex(ax[3,0])

for i_group, current_group in enumerate(df_concat['WL_group'].sort_values().unique()):
    current_df_group = df_concat[df_concat['WL_group'] == current_group]
    for i_col, col in enumerate(xlabel_dict.keys()):
        ax[i_col, i_group].hist(current_df_group[col], bins=np.linspace(0, 0.2, round(np.sqrt(current_df_group[col].size))),density=True)
        ax[i_col, i_group].set_xlabel(xlabel_dict[col])
    ax[0, i_group].set_title(str(current_group) + '\n' + f'$WL \\in \\ [{current_df_group["WL_mode_avg"].min():.2f}, {current_df_group["WL_mode_avg"].max():.2f}]$')


fig, ax = plt.subplots(4, 6, sharex='row', figsize=(18,9), layout='constrained')
fig.suptitle('AvrTM')
ax[0,0].sharex(ax[1,0])
ax[2,0].sharex(ax[3,0])

for i_group, current_group in enumerate(df_concat['AvrTM_group'].sort_values().unique()):
    current_df_group = df_concat[df_concat['AvrTM_group'] == current_group]
    for i_col, col in enumerate(xlabel_dict.keys()):
        ax[i_col, i_group].hist(current_df_group[col], bins=np.linspace(0, 0.2, round(np.sqrt(current_df_group[col].size))),density=True)
        ax[i_col, i_group].set_xlabel(xlabel_dict[col])
    ax[0, i_group].set_title(str(current_group) + '\n' + f'$AvrTM \\in \\ [{current_df_group["AvrTM(s)"].min():.2f}, {current_df_group["AvrTM(s)"].max():.2f}]$')












